@model EditUserDTO
@{
	TempData["Title"] = "Edit User";
}

<!-- Page header -->
<div class="page-header page-header-default">
	<div class="page-header-content">
		<div class="page-title">
			<h4><i class="icon-arrow-left52 position-left"></i> <span class="text-semibold">Administration</span> - Users - Edit User</h4>
		</div>

		<div class="heading-elements">
			<div class="heading-btn-group">
				<a href="#" class="btn btn-link btn-float has-text"><i class="icon-bars-alt text-primary"></i><span>Statistics</span></a>
				<a href="#" class="btn btn-link btn-float has-text"><i class="icon-calculator text-primary"></i> <span>Invoices</span></a>
				<a href="#" class="btn btn-link btn-float has-text"><i class="icon-calendar5 text-primary"></i> <span>Schedule</span></a>
			</div>
		</div>
	</div>

	<div class="breadcrumb-line">
		<ul class="breadcrumb">
			<li><a asp-action="Index" asp-controller="Home"><i class="icon-home2 position-left"></i> Home</a></li>
			<li><a asp-action="GetUsers" asp-controller="User">Users</a></li>
			<li class="active">Edit User</li>
		</ul>

		<ul class="breadcrumb-elements">
			<li><a href="#"><i class="icon-comment-discussion position-left"></i> Support</a></li>
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">
					<i class="icon-gear position-left"></i>
					Settings
					<span class="caret"></span>
				</a>

				<ul class="dropdown-menu dropdown-menu-right">
					<li><a href="#"><i class="icon-user-lock"></i> Account security</a></li>
					<li><a href="#"><i class="icon-statistics"></i> Analytics</a></li>
					<li><a href="#"><i class="icon-accessibility"></i> Accessibility</a></li>
					<li class="divider"></li>
					<li><a href="#"><i class="icon-gear"></i> All settings</a></li>
				</ul>
			</li>
		</ul>
	</div>
</div>
<!-- /page header -->

<div class="content">
	<div class="row">
		<form id="editUserForm" class="form-basic" asp-action="EditUser" asp-controller="User" asp-route-userId="@Model.Id" method="post">
            <div asp-validation-summary="All"></div>

			<div class="col-md-12">
				<div class="panel panel-flat border-left-lg border-left-teal">
					<div class="panel-heading" style="height:70px">
                        <h6 class="panel-title ">
							<a class="collapsed" data-toggle="collapse" data-parent="#accordion-control-right"
							   href="#editUser" aria-expanded="false">
								<legend class="text-semibold "><i class="icon-reading position-left"></i> Edit User</legend>
							</a>

						</h6>
					</div>
					<div id="editUser" class="panel-collapse collapse in">
						<div class="panel-body" >
							<fieldset class="step" id="step1">
								<div class="row">
									<div class="col-md-6">
										<label class="form-label">First Name <span class="text-danger">*</span></label>
										<div class="form-group">
											<div class="input-group">
												<span class="input-group-addon"><i class="icon-user"></i></span>
												<input asp-for="FirstName" class="form-control" placeholder="First Name">
												<span class="validation-badge" asp-validation-for="FirstName"></span>
											</div>
										</div>
									</div>



										<div class="col-md-6">
											<label>Last Name</label>
											<div class="form-group">
												<div class="input-group input-group">
												<span class="input-group-addon"><i class="icon-user"></i></span>
													<input asp-for="LastName" class="form-control" placeholder="Last Name">
												</div>
											<span class="text-danger validation-error-label" asp-validation-for="LastName"></span>
											</div>
										</div>

									</div>

								<div class="row">
										<div class="col-md-6">
											<label>User Name</label>
											<div class="form-group">
												<div class="input-group input-group">
												<span class="input-group-addon"><i class="icon-user"></i></span>
													<input asp-for="UserName" class="form-control" placeholder="User Name">
												</div>
											<span class="text-danger validation-error-label" asp-validation-for="UserName"></span>
											</div>
										</div>
										<div class="col-md-6">
											<label>E-mail Address</label>
											<div class="form-group">
												<div class="input-group input-group">
													<span class="input-group-addon"><i class="fa-solid fa-envelope"></i></span>
													<input asp-for="Email" class="form-control" placeholder="your@email.com">
												</div>
											<span class="text-danger validation-error-label" asp-validation-for="Email"></span>
											</div>
										</div>

									</div>

								<div class="row">
									<div class="col-md-6">
										<label>Default Branch<span class="text-danger">*</span></label>
										<div class="form-group">
											<div class="input-group input-group">
												<span class="input-group-addon"><i class="icon-user"></i></span>
												<select asp-for="DefaultBranchId" id="DefaultBranchId" class="form-control select" required data-placeholder="Default Branch">
													<option value=""></option>

													@foreach (var item in Model.AllBranches)
													{
														<option value="@item.Id">@item.DisplayText</option>
													}
												</select>
											</div>
											<span class="text-danger validation-error-label" asp-validation-for="DefaultBranchId"></span>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<div class="alpaca-control checkbox">
											<label class="checkbox-inline checkbox-left checkbox-switchery switchery-sm">
												<input type="checkbox" asp-for="IsActive" class="switchery">
												Is Active
											</label>
										</div>
										<span class="text-danger validation-error-label" asp-validation-for="IsActive"></span>
									</div>
								</div>
							</fieldset>
							<br />
						</div>
					</div>
				</div>
			</div>
           
			<div class="col-md-6">
				<div class="panel panel-flat border-left-lg border-left-teal">
					<div class="panel-heading" style="height:70px">
						<h6 class="panel-title">
							<a class="collapsed" data-toggle="collapse" data-parent="#accordion-control-right"
							   href="#assignBranches" aria-expanded="false">
								<legend class="text-semibold"><i class="icon-pin-alt"></i> Assign Branches To User:</legend>
							</a>
						</h6>
					</div>
					<div class="collapse in">
						<div class="panel-body">
							<div class="row">
								<div class="col-md-12">
									<div class="form-group">
										@foreach (var branch in Model.AllBranches)
										{
											var isDefault = Model.DefaultBranchId == branch.Id;
											var isChecked = isDefault || Model.SelectedBranchIds.Contains(branch.Id);

											<div class="col-md-6">
												<label class="checkbox-container">
													<input type="checkbox"
														   name="SelectedBranchIds"
														   class="checkbox-input roomTypeCheckbox"
														   value="@branch.Id" />

													@* @if (isDefault)
													{
														<!-- Hidden input to ensure default branch still posted -->
														<input type="hidden" name="SelectedBranchIds" value="@branch.Id" />
													} *@

													<div class="checkbox-custom"></div>
													<a class="text-default">@branch.DisplayText</a>
												</label>
											</div>
										}
									</div>
								</div>
							</div>
							<br />
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="panel panel-flat border-left-lg border-left-teal">
					<div class="panel-heading" style="height:70px">
						<h6 class="panel-title">
							<a class="collapsed" data-toggle="collapse" data-parent="#accordion-control-right"
							   href="#assignRoles" aria-expanded="false">
								<legend class="text-semibold"><i class="icon-user-lock"></i> Assign Roles To User:</legend>
							</a>
						</h6>
					</div>
					<div class="collapse in">
						<div class="panel-body">
							<div class="row">
								<div class="col-md-12">

									<div class="form-group">
										@foreach (var role in Model.AllRoles)
										{
											<div class="col-md-6">
												<label class="checkbox-container">
													<input type="checkbox" name="SelectedRoles"
														class="checkbox-input roomTypeCheckbox" value="@role"
													@(Model.SelectedRoles.Contains(role) ? "checked" : "")>
													<div class="checkbox-custom"></div>
													<a class="text-default">@role</a>
												</label>
											</div>
										}
									</div>
								</div>
							</div>
							<br />
						</div>
					</div>
				</div>
			</div>

			<div class="text-center">
				<a class="btn btn-default btn-lg" asp-action="Index" asp-controller="User"> Cancel</a>
				<button type="submit" class="btn bg-teal-400 btn-lg btn-ladda btn-ladda-spinner ladda-button" data-spinner-color="#fff" data-style="radius"><i class="icon-checkmark4"></i> Save</button>
			</div>
    </form>

</div>

</div>




@section Scripts{

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			// Inject server values
			var defaultBranchId = '@(Model.DefaultBranchId == null ? "" : Model.DefaultBranchId.ToString())';

			// Serialize previously selected branches to JS (strings to match checkbox value attributes)
			var selectedBranchIds = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
			(Model.SelectedBranchIds ?? new List<int>()).Select(x => x.ToString()).ToList()
			));

			// 1) Pre-check all previously saved branches
			(selectedBranchIds || []).forEach(function (id) {
				document.querySelectorAll('input[name="SelectedBranchIds"][value="' + id + '"]')
					.forEach(cb => cb.checked = true);
			});

			// 2) Make sure the default branch is checked and the dropdown reflects it
			if (defaultBranchId) {
				var defaultSelect = document.getElementById('DefaultBranchId');
				if (defaultSelect) {
					defaultSelect.value = defaultBranchId;
					// If you're using Select2 or similar, uncomment the next line:
					// $(defaultSelect).trigger('change.select2');
					defaultSelect.dispatchEvent(new Event('change'));
				}
				document.querySelectorAll('input[name="SelectedBranchIds"][value="' + defaultBranchId + '"]')
					.forEach(cb => cb.checked = true);
			}

			// 3) When default changes, check the same branch in the list and update guarding logic
			document.getElementById('DefaultBranchId')?.addEventListener('change', function (e) {
				var id = e.target.value;
				if (!id) return;
				defaultBranchId = id; // update current default we're guarding
				var cb = document.querySelector('input[name="SelectedBranchIds"][value="' + id + '"]');
				if (cb) cb.checked = true;
			});

			// 4) Prevent unchecking the current default from the checkbox list
			document.addEventListener('change', function (e) {
				var el = e.target;
				if (el && el.matches('input[name="SelectedBranchIds"]')) {
					if (defaultBranchId && el.value === defaultBranchId && !el.checked) {
						// Re-check it; it's the default
						el.checked = true;
					}
				}
			});
		});
	</script>



	@await Html.PartialAsync("_ValidationScriptsPartial")
}