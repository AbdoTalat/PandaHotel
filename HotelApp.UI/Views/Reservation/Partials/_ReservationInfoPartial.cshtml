@model ReservationInfoDTO

<div class="row">

    <form id="bookRoomForm">
        <input type="hidden" id="ReservationId" value="@Model.ReservationId" />

        <div class="row">

            <!-- ================= Stay Information ================= -->
            <div class="col-md-12">
                <legend class="text-semibold">
                    <i class="icon-calendar22 position-left"></i> Stay Information
                </legend>
                <div class="row">
                    <!-- Check-in -->
                    <div class="col-md-5">
                        <label>Check-In <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="icon-calendar22"></i></span>
                            <input type="text" autocomplete="off"
                                   class="form-control daterange-time"
                                   id="CheckInVisible"
                                   placeholder="check-in Date"
                                   value="@(Model.CheckInDate != DateTime.MinValue ? Model.CheckInDate.ToString("dd/MM/yyyy hh:mm tt") : "")" />
                            <input type="hidden" asp-for="CheckInDate" id="CheckInDate" />
                        </div>
                        <span asp-validation-for="CheckInDate" class="text-danger validation-error-label"></span>
                    </div>

                    <!-- Nights -->
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Nights</label>
                            <input type="text" class="form-control" asp-for="NumOfNights" id="NumOfNights" placeholder="Nights" readonly
                                   value="@(Model.CheckInDate != DateTime.MinValue && Model.CheckOutDate != DateTime.MinValue
                             ? Math.Floor((Model.CheckOutDate - Model.CheckInDate).TotalDays).ToString()
                             : "")" />
                            <span asp-validation-for="NumOfNights" class="text-danger validation-error-label"></span>
                        </div>
                    </div>

                    <!-- Check-out -->
                    <div class="col-md-5">
                        <label>Check-Out <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="icon-calendar22"></i></span>
                            <input type="text" autocomplete="off"
                                   class="form-control"
                                   id="CheckOutVisible"
                                   placeholder="check-out Date"
                                   value="@(Model.CheckOutDate != DateTime.MinValue ? Model.CheckOutDate.ToString("dd/MM/yyyy hh:mm tt") : "")"
                                   readonly />
                            <input type="hidden" asp-for="CheckOutDate" id="CheckOutDate" />
                        </div>
                        <span asp-validation-for="CheckOutDate" class="text-danger validation-error-label"></span>
                    </div>
                </div>


                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Reservation Source <span class="text-danger">*</span></label>
                            <select asp-for="ReservationSourceId" data-selected="@Model?.ReservationSourceId" id="reservationSourceSelect" class="form-control select" required data-placeholder="Reservation Source">
                                <option value=""></option>
                            </select>
                            <span asp-validation-for="ReservationSourceId" class="text-danger validation-error-label"></span>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Company</label>
                            <div class="form-group has-feedback">
                                <input type="text" class="form-control" id="selectedCompanyName" readonly placeholder="Select Company..." data-toggle="modal" data-target="#companyModal">
                                <div class="form-control-feedback">
                                    <i class="icon-search4 text-size-base"></i>
                                </div>
                            </div>
                            <input type="hidden" asp-for="CompanyId" id="CompanyId" />
                            <span asp-validation-for="CompanyId" class="text-danger validation-error-label"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= Room Information ================= -->
            <div class="col-md-12">
                <legend class="text-semibold">
                    <i class="icon-home4 position-left"></i> Rooms Information
                </legend>

                <div class="form-group">
                    <label class="display-block text-semibold">Reservation Type</label>
                    <label class="radio-inline">
                        <input type="radio" id="singleBtn" name="reservationType" checked class="styled border-teal text-teal-600" value="single">
                        Single
                    </label>

                    <label class="radio-inline">
                        <input type="radio" id="groupBtn" name="reservationType" class="styled border-teal text-teal-600" value="group">
                        Group
                    </label>
                </div>
                <table class="table table-xxs table-bordered " id="roomTable">
                    <thead>
                        <tr class="active">
                            <th class="col-lg-1">Room Type</th>
                            <th class="col-lg-1">No. of Rooms</th>
                            <th class="col-lg-1">Adults</th>
                            <th class="col-lg-1">Children</th>
                            <th class="col-lg-1"></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <span asp-validation-for="RoomTypeToBookDTOs" class="text-danger validation-error-label"></span>

                <div id="addRoomWrapper" style="margin-top:10px;">
                    <button type="button" id="addRoomBtn" class="btn text-teal-800 border-teal btn-flat">
                        <i class="icon-plus22 position-left"></i> Add Room
                    </button>
                </div>

                <div class="row" style="margin-top:30px;">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Select Available Rooms</label>
                            <div class="input-group">
                                <select id="roomsSelect" class="form-control" multiple="multiple"></select>
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#rateModal">
                                        <i class="icon-search4 text-size-base"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Rate <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select id="rateSelect" asp-for="RateId" data-selected="@Model?.RateId" name="RateId" class="form-control select" required data-placeholder="Choose Rate">
                                    <option></option>
                                </select>
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#rateModal">
                                        <i class="icon-info22 text-size-base"></i> Rate Details
                                    </button>
                                </div>
                            </div>
                            <span asp-validation-for="RateId" class="text-danger validation-error-label"></span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>


<div id="rateModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h5 class="modal-title">Rate Details</h5>
            </div>

            <div class="modal-body">
                <div class="panel">

                    <div class="panel-body">
                        <div id="rateDetails" class="col-md-12"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>
<div id="companyModal" class="modal fade in" style="display: none; padding-right: 15px;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h5 class="modal-title">Company</h5>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>Serach company </label>
                            <select id="companySelect" class="form-control select" data-placeholder="Search by company name...">
                                <option></option>
                            </select>
                        </div>
                    </div>
                </div>
                <form id="companyForm">
                    <input type="hidden" id="CompanyIdHidden" value="0" />

                    <div class="panel panel-flat border-left-sm border-left-teal ">
                        <div class="panel-body">
                            <div class="content">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyName">Name <span class="text-danger">*</span></label>
                                            <input type="text" id="CompanyName" name="CompanyName" class="form-control" required />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyPhone">Phone <span class="text-danger">*</span></label>
                                            <input type="text" id="CompanyPhone" name="CompanyPhone" class="form-control" required />
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyAddress">Address</label>
                                            <input type="text" id="CompanyAddress" name="CompanyAddress" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyEmail">Email</label>
                                            <input type="text" id="CompanyEmail" name="CompanyEmail" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyNotes">Notes</label>
                                            <textarea id="CompanyNotes" name="CompanyNotes" class="form-control" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="button" class="btn btn-link" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn bg-teal-400" id="saveCompanySelection">Save</button>

                    </div>
                </form>
            </div>
        </div>
    </div>
</div>






<script>
    $(function () {
        const $companySelect = $('#companySelect');
        const $companyForm = $('#companyForm');

        // ======== Select2 Setup ========
        $companySelect.select2({
            placeholder: "Search company...",
            minimumInputLength: 4,
            ajax: {
                url: '/Company/GetSerachedCompaniesByName',
                dataType: 'json',
                delay: 250,
                data: params => ({ name: params.term }),
                processResults: data => ({
                    results: data.map(c => ({ id: c.id, text: c.displayText }))
                })
            }
        });

        // ======== Preload Company (Edit Mode) ========
        const existingCompanyId = $('#CompanyId').val();
        if (existingCompanyId && existingCompanyId !== "0") {
            $.get(`/Company/GetSerachedCompanyData/${existingCompanyId}`)
                .done(c => {
                    $('#selectedCompanyName').val(c.name);
                    $('#CompanyIdHidden').val(c.id);
                })
                .fail(() => console.warn('⚠️ Failed to preload company for edit mode.'));
        }

        // ======== When company selected from search ========
        $companySelect.on('select2:select', e => {
            const id = e.params.data.id;
            $.get(`/Company/GetSerachedCompanyData/${id}`)
                .done(c => {
                    $('#CompanyIdHidden').val(c.id);
                    $('#CompanyName').val(c.name);
                    $('#CompanyPhone').val(c.phone);
                    $('#CompanyAddress').val(c.address);
                    $('#CompanyEmail').val(c.email);
                    $('#CompanyNotes').val(c.notes);
                })
                .fail(() => alert('⚠️ Failed to fetch company details'));
        });

        // ======== Save company in modal ========
        $companyForm.on('submit', function (e) {
            e.preventDefault();

            const dto = {
                Id: $('#CompanyIdHidden').val() || 0,
                Name: $('#CompanyName').val() || null,
                Phone: $('#CompanyPhone').val() || null,
                Address: $('#CompanyAddress').val() || null,
                Email: $('#CompanyEmail').val() || null,
                Notes: $('#CompanyNotes').val() || null
            };

            $.ajax({
                url: '/Company/SaveCompany',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dto)
            })
                .done(res => {
                    if (res.success) {
                        $('#selectedCompanyName').val(res.name);
                        $('#CompanyId').val(res.companyId);

                        $('#companyModal').modal('hide');
                        $companyForm[0].reset();
                        $('#CompanyIdHidden').val('');
                        $companySelect.val(null).trigger('change');
                    } else {
                        alert('⚠️ Error saving company');
                    }
                })
                .fail(() => alert('⚠️ Server error while saving company'));
        });
    });
</script>

<script>
    $(function () {
        function clearDates() {
            $('#CheckInDate, #CheckOutDate, #NumOfNights').val('');
            $('#CheckInVisible, #CheckOutVisible').val('');
        }

        // Determine start/end only if values exist
        let startCheckIn = $('#CheckInVisible').val() || null;
        let endCheckOut = $('#CheckOutVisible').val() || null;

        $('.daterange-time').daterangepicker({
            timePicker: true,
            timePicker24Hour: false,
            autoUpdateInput: false,
            locale: {
                cancelLabel: 'Clear',
                format: 'DD/MM/YYYY hh:mm A'
            },
            applyClass: 'bg-slate-600',
            cancelClass: 'btn-default',
            startDate: startCheckIn ? moment(startCheckIn, 'DD/MM/YYYY hh:mm A') : undefined,
            endDate: endCheckOut ? moment(endCheckOut, 'DD/MM/YYYY hh:mm A') : undefined
        });

        $('.daterange-time').on('apply.daterangepicker', function (ev, picker) {
            const checkIn = picker.startDate;
            const checkOut = picker.endDate;

            if (!checkIn || !checkOut || checkIn >= checkOut) {
                showAlert('error', 'Invalid Dates', 'Check-out must be after check-in.');
                clearDates();
                return;
            }

            $('#CheckInDate').val(checkIn.format('YYYY-MM-DDTHH:mm')).trigger('change');
            $('#CheckOutDate').val(checkOut.format('YYYY-MM-DDTHH:mm')).trigger('change');

            $('#CheckInVisible').val(checkIn.format('DD/MM/YYYY hh:mm A'));
            $('#CheckOutVisible').val(checkOut.format('DD/MM/YYYY hh:mm A'));

            const nights = Math.floor(checkOut.diff(checkIn, 'days', true));
            $('#NumOfNights').val(nights);
        });

        $('.daterange-time').on('cancel.daterangepicker', function () {
            clearDates();
        });
    });
</script>

<script>
    $(document).ready(function () {
        const $roomsSelect = $('#roomsSelect');
        const selectedRoomIds = @Html.Raw(Json.Serialize(Model.RoomsIDs)); // already selected rooms from model

        // Initialize Select2
        $roomsSelect.select2({
            placeholder: "Search & select available rooms...",
            minimumInputLength: 2,
            ajax: {
                url: '/Room/GetAvailableRooms',
                dataType: 'json',
                delay: 250,
                data: params => ({
                    name: params.term // search term
                }),
                processResults: data => {
                    if (data.success) {
                        return {
                            results: data.data // expected format [{id:1, text:'Room 101'}, ...]
                        };
                    }
                    return { results: [] };
                },
                cache: true
            }
        });

        // ========== Preselect rooms for edit ==========
        if (selectedRoomIds && selectedRoomIds.length > 0) {
            $.ajax({
                url: '/Room/GetRoomsForEditReservationByIDs',
                type: 'GET',
                data: { ids: selectedRoomIds },
                traditional: true, // allows ?ids=1&ids=2&ids=3
                success: function (data) {
                    if (data.success && Array.isArray(data.data)) {
                        data.data.forEach(room => {
                            // Create and append option if not exists
                            if ($roomsSelect.find("option[value='" + room.id + "']").length === 0) {
                                const option = new Option(room.text, room.id, true, true);
                                $roomsSelect.append(option);
                            }
                        });
                        $roomsSelect.trigger('change'); // refresh UI
                    }
                }
            });
        }
    });
</script>

<script>
    let isGroupMode = false;

    $(function () {

        $('#addRoomBtn').on('click', function (e) {
            e.preventDefault();
            addRoomRow();
        });
        // ======== Elements ========
        const $rateSelect = $('#rateSelect');
        const $checkIn = $('#CheckInDate');
        const $checkOut = $('#CheckOutDate');
        const $modal = $('#rateModal');
        const $rateDetails = $('#rateDetails');

        // Prefill check-out and rate ID from model
        const modelCheckOut = '@Model.CheckOutDate.ToString("yyyy-MM-ddTHH:mm")';
        if (modelCheckOut) $checkOut.val(modelCheckOut);

        const modelCheckIn = '@Model.CheckInDate.ToString("yyyy-MM-ddTHH:mm")';
        if (modelCheckIn) $checkIn.val(modelCheckIn);


        const modelRateId = '@Model.RateId';

        // ======== Helpers ========
        function fillOptions($select, start, end, selected = null) {
            $select.empty().append('<option></option>');
            for (let i = start; i <= end; i++) $select.append(`<option value="${i}">${i}</option>`);
            if (selected !== null && selected >= start && selected <= end) {
                $select.val(selected).trigger('change.select2');
            }
        }

        function updateRowCapacities($row) {
            const $roomType = $row.find('.room-type-select');
            const $numRooms = $row.find('.num-rooms-select');
            const $adults = $row.find('.num-adults-select');
            const $children = $row.find('.num-children-select');

            const opt = $roomType.find('option:selected');
            if (!opt.length) return;

            const maxRooms = +opt.data('count') || 0;
            const maxAdults = +opt.data('maxAdults') || 0;
            const maxChildren = +opt.data('maxChildren') || 0; // ✅ fixed line
            const rooms = +$numRooms.val() || 1;

            fillOptions($numRooms, 1, maxRooms, rooms);
            fillOptions($adults, 1, maxAdults * rooms, +$adults.val() || 1);
            fillOptions($children, 0, maxChildren * rooms, +$children.val() || 0);
        }


        function refreshAllRoomTypeOptions() {
            const allSelects = $('.room-type-select');
            const selected = allSelects.map((_, el) => $(el).val()).get().filter(Boolean);
            allSelects.each(function () {
                const current = $(this).val();
                $(this).find('option').each(function () {
                    const val = $(this).val();
                    $(this).prop('disabled', isGroupMode && val && val !== current && selected.includes(val));
                });
            }).trigger('change.select2');
        }

        function initializeRow($row) {
            const $roomType = $row.find('.room-type-select');
            const $numRooms = $row.find('.num-rooms-select');

            $roomType.select2({ width: '100%', placeholder: $roomType.data('placeholder') })
                .on('change', function () {
                    const $row = $(this).closest('tr');
                    updateRowCapacities($row);
                    refreshAllRoomTypeOptions();
                    updateRates(); // 🔹 call rates update on room type change
                });

            $numRooms.select2({ width: '100%' }).on('change', function () {
                const $row = $(this).closest('tr');
                updateRowCapacities($row);
                updateRates(); // 🔹 update rates when quantity changes
            });

            $row.find('.num-adults-select, .num-children-select').select2({ width: '100%' });
        }

        function updateRemoveButtons() {
            const rows = $('#roomTable tbody tr');
            rows.find('.remove-room-btn').toggle(rows.length > 1);
        }

        // ======== Add / Remove Rows ========
        function addRoomRow(prefill = null) {
            const lastRow = $('#roomTable tbody tr').last();
            if (lastRow.length && !lastRow.find('.room-type-select').val()) {
                toastr.warning("Please select a room type in the last row first.");
                return;
            }

            const selectedIds = $('.room-type-select').map((_, el) => $(el).val()).get().filter(Boolean);
            let optionsHtml = `<option></option>`;
            @foreach (var item in ViewBag.RoomTypes)
            {
                <text>
                    if (!(isGroupMode && selectedIds.includes("@item.Id"))) {
                    optionsHtml += `<option value="@item.Id"
            data-name="@item.Name"
            data-count="@item.NumOfAvailableRooms"
            data-max-adults="@item.MaxNumOfAdults"
            data-max-children="@item.MaxNumOfChildrens">
                @item.Name (@item.NumOfAvailableRooms available)
        </option>`;

                    }
                </text>
            }

                const $newRow = $(`
                    <tr>
                        <td><select class="form-control select room-type-select" data-placeholder="Room Type">${optionsHtml}</select></td>
                        <td><select class="form-control select num-rooms-select" data-placeholder="Rooms"></select></td>
                        <td><select class="form-control select num-adults-select" data-placeholder="Adults"></select></td>
                        <td><select class="form-control select num-children-select" data-placeholder="Children"></select></td>
                        <td><button type="button" class="btn btn-default btn-sm remove-room-btn"><i class="icon-x"></i></button></td>
                    </tr>
                `);

            $('#roomTable tbody').append($newRow);
            initializeRow($newRow);

            if (prefill) {
                $newRow.find('.room-type-select').val(prefill.RoomTypeId).trigger('change');
                $newRow.find('.num-rooms-select').val(prefill.NumOfRooms).trigger('change');
                $newRow.find('.num-adults-select').val(prefill.NumOfAdults).trigger('change');
                $newRow.find('.num-children-select').val(prefill.NumOfChildrens).trigger('change');
            }

            updateRemoveButtons();
            refreshAllRoomTypeOptions();
            updateRates(); // 🔹 update rates after adding a row
        }

        function removeRoomRow(btn) {
            $(btn).closest('tr').remove();
            updateRemoveButtons();
            refreshAllRoomTypeOptions();
            updateRates(); // 🔹 update rates after removing a row
        }

        // ======== Modes ========
        function setToSingleMode() {
            isGroupMode = false;
            $('#addRoomWrapper').hide();

            $('#singleBtn').prop('checked', true);
            $('#groupBtn').prop('checked', false);

            const rows = $('#roomTable tbody tr');
            if (rows.length > 1) rows.slice(1).remove();
            refreshAllRoomTypeOptions();
            updateRates();
        }

        function setToGroupMode() {
            isGroupMode = true;
            $('#addRoomWrapper').show();

            $('#groupBtn').prop('checked', true);
            $('#singleBtn').prop('checked', false);
            refreshAllRoomTypeOptions();
            updateRates();
        }


        // ======== Rates Handling ========
        function updateRates() {
            const roomTypeIds = $('#roomTable .room-type-select').map(function () {
                return $(this).val() || null;
            }).get().filter(Boolean);

            if (!roomTypeIds.length || !$checkIn.val() || !$checkOut.val()) {
                resetRates();
                return;
            }

            $.ajax({
                url: '/Rate/GetRatesByRoomTypes',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    RoomTypeIds: roomTypeIds,
                    CheckInDate: new Date($checkIn.val()),
                    CheckOutDate: new Date($checkOut.val())
                })
            })
                .done(rates => {
                    $rateSelect.empty().append(new Option('Select Rate', '', false, false));
                    rates.forEach(rate => {
                        const roomTypeInfo = rate.roomTypeRateForReservations.map(rt => `${rt.typeName} ($${rt.dailyPrice})`).join(' - ');
                        const optionText = `${rate.name}|||${roomTypeInfo}`;
                        $rateSelect.append(new Option(optionText, rate.id, false, false));
                    });

                    $rateSelect.select2({
                        width: '100%',
                        placeholder: "Choose Rate",
                        templateResult: formatRateOption,
                        templateSelection: formatRateOption
                    });

                    if (modelRateId) $rateSelect.val(modelRateId).trigger('change');
                })
                .fail(xhr => { console.error(xhr.responseText); resetRates(); });
        }

        function resetRates() {
            $rateSelect.empty().append(new Option('Select Rate', '', false, false)).val(null).trigger('change');
            $rateDetails.empty().hide();
        }

        function formatRateOption(option) {
            if (!option.id) return option.text;
            const [name, types] = option.text.split('|||');
            return $(`<div><span class="text-success"><b>${name}</b></span><small> - ${types}</small></div>`);
        }

        function loadRateDetails() {
            const rateId = $rateSelect.val();
            const checkIn = $checkIn.val();
            const checkOut = $checkOut.val();

            if (!rateId || !checkIn || !checkOut) {
                $rateDetails.html('<p class="text-danger">Please select a rate, check-in, and check-out.</p>').show();
                return;
            }

            const roomTypeQuantities = [];
            $('#roomTable tbody tr').each(function () {
                const roomTypeId = $(this).find('.room-type-select').val();
                const quantity = $(this).find('.num-rooms-select').val();
                if (roomTypeId && quantity) roomTypeQuantities.push({ RoomTypeId: parseInt(roomTypeId), Quantity: parseInt(quantity) });
            });

            if (!roomTypeQuantities.length) {
                $rateDetails.html('<p class="text-danger">Please add at least one room with quantity.</p>').show();
                return;
            }

            $.ajax({
                url: '/Rate/GetReservationChargesSummary',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    RateId: parseInt(rateId),
                    CheckIn: new Date(checkIn),
                    CheckOut: new Date(checkOut),
                    roomTypeQuantities: roomTypeQuantities
                })
            })
                .done(res => {
                    if (!res.success || !res.data) {
                        $rateDetails.html(`<p class="text-danger">${res.message || 'No calculation available.'}</p>`).show();
                        return;
                    }
                    const summary = res.data.chargesSummary;
                    let html = `<table class="table table-bordered">
                                    <thead><tr><th>Charge</th><th>Unit</th><th>Rate</th><th>Total</th></tr></thead>
                                    <tbody>`;
                    summary.forEach(item => {
                        if (item.charge) html += `<tr><td>${item.charge}</td><td>${item.unit}</td><td>${item.rate}</td><td>${item.total}</td></tr>`;
                    });
                    html += `</tbody></table><h4 class="text-success">Total Price: ${res.data.totalPrice}</h4>`;
                    $rateDetails.html(html).show();
                })
                .fail(xhr => { console.error(xhr.responseText); $rateDetails.html('<p class="text-danger">Error loading charges summary.</p>').show(); });
        }

        $modal.on('show.bs.modal', loadRateDetails);
        $modal.on('click', '[data-action="reload"]', e => { e.preventDefault(); loadRateDetails(); });

        // ======== Init ========
        $('#singleBtn').on('click', setToSingleMode);
        $('#groupBtn').on('click', setToGroupMode);
        $(document).on('click', '.remove-room-btn', function () { removeRoomRow(this); });
        $(document).on('change', '#CheckInDate, #CheckOutDate', updateRates);

        // Prefill rows for edit mode
        const prefillRooms = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RoomTypeToBookDTOs ?? []));
        if (prefillRooms.length) {
            if (prefillRooms.length > 1) setToGroupMode();
                prefillRooms.forEach(r => addRoomRow(r));
        } else addRoomRow();

        updateRemoveButtons();
        updateRates();
    });
</script>

<script>
    $("#bookRoomForm").on("submit", function (e) {
        e.preventDefault();

        const companyIdVal = $("#CompanyId").val();
        const formData = {
            ReservationId: $("#ReservationId").val(),
            CheckInDate: $("#CheckInDate").val(),
            CheckOutDate: $("#CheckOutDate").val(),
            NumOfNights: $("#NumOfNights").val(),
            ReservationSourceId: $("#reservationSourceSelect").val(),
            RateId: $("#rateSelect").val(),
            companyId: companyIdVal ? parseInt(companyIdVal) : null,
            roomTypeToBookDTOs: [],
            RoomsIDs: [] // ✅ init list for room IDs
        };

        // ✅ Extract selected room types from the dynamic table
        $("#roomTable tbody tr").each(function () {
            const roomTypeId = $(this).find("select").eq(0).val();
            const numOfRooms = $(this).find(".num-rooms-select").val();
            const numAdults = $(this).find(".num-adults-select").val();
            const numChildren = $(this).find(".num-children-select").val();

            if (roomTypeId && numOfRooms > 0) {
                formData.roomTypeToBookDTOs.push({
                    RoomTypeId: parseInt(roomTypeId),
                    NumOfRooms: parseInt(numOfRooms),
                    NumOfAdults: parseInt(numAdults || 0),
                    NumOfChildrens: parseInt(numChildren || 0)
                });
            }
        });

        // ✅ Add selected rooms from Select2
        const selectedRooms = $("#roomsSelect").val(); // array of selected IDs as strings
        if (selectedRooms && selectedRooms.length > 0) {
            formData.RoomsIDs = selectedRooms.map(id => parseInt(id));
        }

        $.ajax({
            url: '/Reservation/SaveRoomToBook',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (response) {
                if (response.success) {
                    toastr.success(response.message, 'Success');

                    // Confirmation info
                    $("#confirmCheckIn").text(formData.CheckInDate);
                    $("#confirmCheckOut").text(formData.CheckOutDate);

                    const checkIn = new Date(formData.CheckInDate);
                    const checkOut = new Date(formData.CheckOutDate);
                    const nights = $('#NumOfNights').val();
                    $("#confirmNights").text(nights);

                    if (response.amount) {
                        $("#confirmAmount").text(response.amount + " EGP");
                    }

                    $(document).trigger("roomBookingSuccess");
                } else {
                    $("#bookRoomContainer").html(response);
                    showAlert('error', 'Validation Error', response.message);
                }
            },
            error: function () {
                Swal.fire("Error", "Failed to save room booking.", "error");
            }
        });
    });


</script>
