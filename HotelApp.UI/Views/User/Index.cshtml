@model IEnumerable<UsersDTO>
@{
	TempData["Title"] = "Users";
}
<!-- Page header -->
<div class="page-header page-header-default">
	<div class="page-header-content">
		<div class="page-title">
			<h4><i class="icon-arrow-left52 position-left"></i> <span class="text-semibold">Users</span></h4>
		</div>

		<div class="heading-elements">
			<div class="heading-btn-group">
				<a href="#" class="btn btn-link btn-float has-text"><i class="icon-bars-alt text-primary"></i><span>Statistics</span></a>
				<a href="#" class="btn btn-link btn-float has-text"><i class="icon-calculator text-primary"></i> <span>Invoices</span></a>
				<a href="#" class="btn btn-link btn-float has-text"><i class="icon-calendar5 text-primary"></i> <span>Schedule</span></a>
			</div>
		</div>
	</div>

	<div class="breadcrumb-line" >
		<ul class="breadcrumb">
			<li><a asp-action="Index" asp-controller="Home"><i class="icon-home2 position-left"></i> Home</a></li>
			@* <li><a asp-action="GetUsers" asp-controller="User">Administration</a></li> *@
			<li class="active">Users (@Model.Count())</li>
		</ul>

		<ul class="breadcrumb-elements">
			<li><a href="#"><i class="icon-comment-discussion position-left"></i> Support</a></li>
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">
					<i class="icon-gear position-left"></i>
					Settings
					<span class="caret"></span>
				</a>

				<ul class="dropdown-menu dropdown-menu-right">
					<li><a href="#"><i class="icon-user-lock"></i> Account security</a></li>
					<li><a href="#"><i class="icon-statistics"></i> Analytics</a></li>
					<li><a href="#"><i class="icon-accessibility"></i> Accessibility</a></li>
					<li class="divider"></li>
					<li><a href="#"><i class="icon-gear"></i> All settings</a></li>
				</ul>
			</li>
		</ul>
	</div>
</div>
<!-- /page header -->



<!-- Content area -->
<div class="content">
  	<div class="panel panel-flat">
        <div class="panel-heading">
            <h5 class="panel-title">Users</h5>

			<div class="heading-elements" >
				@if (User.HasClaim("permission", "User.Add"))
				{
					<a asp-action="AddUser" asp-controller="User" type="button" class="btn bg-teal-400 btn-lg">
						<i class="icon-plus-circle2" style="font-size:21px; margin-right:5px; margin-top:3px"></i>
						Add User
					</a>
				}
			</div>
            
        </div>

		<hr class="my-3" style="margin-top:5px">

		@if (TempData["UserUpdated"] != null)
		{
			<div class="panel-body">
				<div class="row">
					<div class="alert alert-success no-border text-center" style="height:70px; font-size:20px">
						<button type="button" class="close" data-dismiss="alert"><span>×</span><span class="sr-only">Close</span></button>
							@TempData["UserUpdated"]
					</div>
				</div>
			</div>
		}
        <div class="panel-heading" style="margin-bottom:40px">
			<div class="heading-elements" >
				<ul class="icons-list">
					<li><button id="toggleFilterBtn" class="btn bg-teal-400 "><i class="icon-filter3"></i> Filter</button> </li>
					<li><a class="btn bg-teal-400" id="refreshUsersBtn" data-action="reload" style="color:#fff"></a></li>
                    <li><a class="btn bg-teal-400" data-action="collapse" style="color:#fff"></a></li>
				</ul>
            </div>
		</div>
		
		
		<table id="usersTable" class="table datatable-button-html5-basic dataTable">
			<thead>
				<tr class="border-double active">
					<th>Number</th>
					<th>First Name</th>
					<th>Last Name</th>
					<th>User Name</th>
					<th>Email</th>
					<th>User Status</th>
					<th>Created At</th>
					<th class="text-center">Actions</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var item in Model)
				{
					<tr id="item-@item.Id">
                        <td><a>@item.Id</a> </td>
						<td>@item.FirstName</td>
						<td>@item.LastName</td>
						<td>@item.UserName</td>
						<td>@item.Email</td>

						@if (item.IsActive)
						{
							<td><span class="label label-rounded label-success">Active</span></td>
						}
						else
						{
							<td><span class="label label-rounded label-danger">Not Active</span></td>
						}

						<td>@item.CreatedDate.ToShortDateString()</td>

						<td class="text-center">

							@if (User.HasClaim("permission", "User.Edit"))
								{
									<a asp-action="EditUser" asp-controller="User" asp-route-Id="@item.Id" class="text-teal-600">
										<i class="icon-pencil7" style="font-size:20px; margin-right:8px"></i>
									</a>
								}
								@if (User.IsInRole("Admin"))
								{
									@if (User.HasClaim("permission", "User.Delete") && !item.IsActive)
									{
									<a data-url="/User/DeleteUser/@item.Id"
									   class="text-danger-600 btn-delete">
										<i class="icon-trash" style="font-size:20px;margin-right:8px"></i>
									</a>
									}
								}
						</td>
					</tr>
				}
			</tbody>
		</table>


	</div>  

</div>
<!-- /content area-->



@section Scripts {

	<script>
		$(document).ready(function () {
			$("#refreshUsersBtn").click(function () {
				$.ajax({
					url: '/User/GetUsersJson',
					type: 'GET',
					dataType: 'json',
					success: function (response) {
						if (response.success) {
							var tbody = $("#usersTable tbody");
							tbody.empty(); // Clear existing data

							$.each(response.data, function (index, item) {
								var statusLabel = item.isActive === "Active"
									? '<span class="label label-rounded label-success">Active</span>'
									: '<span class="label label-rounded label-danger">Not Active</span>';

								var rolesDropdown = `<ul class="icons-list">
										<li class="dropdown">
											<a href="#" class="dropdown-toggle" data-toggle="dropdown">
												<i class="icon-menu9"></i>
											</a>
											<ul class="dropdown-menu dropdown-menu-right">
												<li><a href="#">${item.roles}</a></li>
											</ul>
										</li>
									</ul>`;

								var actions = "";
								if (item.canEditUser) {
									actions += `<a href="/User/EditUser/${item.id}" class="text-teal-600">
											<i class="icon-pencil7" style="font-size:20px; margin-right:8px"></i>
										</a>`;
								}
								if (item.canDeleteUser) {
									actions += `<a data-id="${item.id}" class="text-danger-600 btn-delete">
											<i class="icon-trash" style="font-size:20px;margin-right:8px"></i>
										</a>`;
								}

								var row = `<tr id="item-${item.id}">
										<td>${item.number}</td>
										<td>${item.firstName}</td>
										<td>${item.lastName}</td>
										<td>${item.userName}</td>
										<td>${item.email}</td>
										<td>${statusLabel}</td>
										<td>${item.createdAt}</td>
										<td class="text-center">${rolesDropdown}</td>
										<td class="text-center">${actions}</td>
									</tr>`;

								tbody.append(row);
							});
						} else {
							console.error("Failed to load users.");
						}
					},
					error: function () {
						console.error("Error while fetching users.");
					}
				});
			});
		});
	</script>

}