@model AddGuestDTO
@{
	int BranchId = ViewBag.BranchId;
}

 <div class="row">
    <div class="col-md-8">
        <div class="panel panel-flat">
            <div class="panel-body">

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>Serach guest </label>
							<select id="guestSearchSelect" class="form-control select" data-placeholder="Search guest by name, email, or phone...">
                                <option></option>
                            </select>
                        </div>
                    </div>
                </div>

                <form id="guestForm">
                    <input type="hidden" id="guestId" value="0" />
					<input type="hidden" id="BranchId" value="0" />

                    <div class="row">
                        <div class="col-md-6">
                            <label class="checkbox-container" id="primaryCheckboxContainer">
                                <input asp-for="IsPrimary" id="isPrimary" type="checkbox" class="checkbox-input">
                                <div class="checkbox-custom"></div>
                                <span>Is Primary</span>
                            </label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="GuestFullName">Guest Name</label>
                                <div class="input-group">
                                    <div class="input-group-btn">
                                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                            Mr. <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a href="#">Mr.</a></li>
                                            <li><a href="#">Mrs.</a></li>
                                            <li><a href="#">Ms.</a></li>
                                            <li><a href="#">Dr.</a></li>
                                        </ul>
                                    </div>

                                    <input asp-for="FullName" id="FullName" class="form-control" required placeholder="Full Name" />

                                    <span class="input-group-addon"><i class="icon-vcard"></i></span>

                                </div>                                   
                                <span class="text-danger validation-error-label" asp-validation-for="FullName"></span>

                            </div>

                        </div>
                    </div>
                   
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Email</label>
                                <input asp-for="Email" id="Email" class="form-control" placeholder="Email">
                                <span class="text-danger validation-error-label" asp-validation-for="Email"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Phone #</label>
                                <input asp-for="Phone" id="Phone" class="form-control" placeholder="Phone Number">
                                <span class="text-danger validation-error-label" asp-validation-for="Phone"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Type Of Proof</label>
								<select id="proofTypeSelect" asp-for="ProofTypeId" class="form-control select" required
										data-placeholder="Choose Proof Type" data-selected="@Model?.ProofTypeId">
									<option value=""></option>
								</select>
                                <span class="text-danger validation-error-label" asp-validation-for="ProofTypeId"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Proof number</label>
                                <input asp-for="ProofNumber" id="ProofNumber" class="form-control" placeholder="Proof number">
                                <span class="text-danger validation-error-label" asp-validation-for="ProofNumber"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input asp-for="DateOfBirth" type="date" id="DateOfBirth" class="form-control">
                                <span class="text-danger validation-error-label" asp-validation-for="DateOfBirth"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Address</label>
                                <input asp-for="Address" id="Address" class="form-control" placeholder="Address">
                                <span class="text-danger validation-error-label" asp-validation-for="Address"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="text-right">
							<button type="button" class="btn btn-default btn-md" id="clearGuestForm">Clear</button>

                            <button type="button" id="addGuestButton" class="btn bg-teal-400 btn-md">
                                <i class="icon-plus-circle2"></i> Add
                            </button>

                        </div>
                    </div>
                </form> 
            </div>

        </div>
    </div>

    <div class="col-md-4">
        <!-- Primary Guest Panel -->
        <div class="panel panel-flat">
            <div class="panel-heading">
                <h6 class="panel-title text-grey-400">Primary Guest</h6>

                <div class="heading-elements">
                    <a><i class="icon-pencil"></i> Change</a>
                </div>
            </div>

           
            <div class="panel-body" id="primaryGuestContainer">
                <!-- Primary guest info here -->
            </div>
        </div>

        <!-- Normal Guests Panel -->
        <div class="panel panel-flat panel-default">
            <div class="panel-heading">
                <h6 class="panel-title">
                    Guests (<span id="guestCount">0</span>)
                </h6>
            </div>
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table " id="normalGuestTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Normal guests will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

</div>

<script>
	$(document).ready(function () {

		// Initialize Select2 for Smart Guest Search
		$('#guestSearchSelect').select2({
			placeholder: "Search guest by name, email, or phone",
			minimumInputLength: 4, // ✅ Enforce 4 characters before search
			ajax: {
				url: '/Guest/SearchGuests', // ✅ Unified endpoint
				dataType: 'json',
				delay: 250,
				data: function (params) {
					return {
						term: params.term
					};
				},
				processResults: function (data) {
					return {
						results: data.map(function (guest) {
							return {
								id: guest.id,
								text: guest.text // e.g. guest.FullName OR guest.Email OR guest.Phone
							};
						})
					};
				},
				cache: true
			}
		});

		// Handle guest selection from Select2
		$('#guestSearchSelect').on('select2:select', function (e) {
			var guestId = e.params.data.id;

			if (guestId) {
				$.ajax({
					url: '/Guest/GetGuestJson/' + guestId,
					type: 'GET',
					success: function (guest) {
						console.log("Guest Data", guest);

						$('#guestId').val(guest.id);
						$('#FullName').val(guest.fullName);
						$('#Email').val(guest.email);
						$('#Phone').val(guest.phone);
						$('#Address').val(guest.address);
						$('#proofTypeSelect').val(guest.proofTypeId).trigger('change'); // ✅ FIXED
						$('#ProofNumber').val(guest.proofNumber);
						$('#BranchId').val(guest.branchId);

						if (guest.dateOfBirth) {
							$('#DateOfBirth').val(guest.dateOfBirth.split('T')[0]);
						} else {
							$('#DateOfBirth').val('');
						}

						$('#guestSearchSelect').val(null).trigger('change');
					},
					error: function () {
						alert('❌ Failed to fetch guest data.');
					}
				});
			}
		});

	});
</script>

<script>
	$(document).ready(function () {
		loadSelect("#proofTypeSelect", "/ProofType/GetProofTypesJson", "name", "id");
	});
</script>

<script>
	let guestList = [];                // For full guest data to show in UI
	let reservationGuestList = [];     // For saving GuestId + IsPrimary only
	let guestCounter = 0;

	$('#addGuestButton').click(function () {
		const form = $('#guestForm');
		const isPrimary = $('#isPrimary').is(':checked');

		let isValid = true;
		let errorMessages = [];

		const fullName = $('#FullName').val().trim();
		if (!fullName) {
			isValid = false;
			errorMessages.push("Full Name is required.");
		}

		if (isPrimary) {
			const dateOfBirth = $('#DateOfBirth').val() || null;
			const address = $('#Address').val().trim();
			const phone = $('#Phone').val().trim();
			const email = $('#Email').val().trim();
			const proofTypeId = $('#proofTypeSelect').val();
			const proofNumber = $('#ProofNumber').val().trim();

			if (!dateOfBirth) {
				isValid = false;
				errorMessages.push("Date of Birth is required for a primary guest.");
			}
			if (!address) {
				isValid = false;
				errorMessages.push("Address is required for a primary guest.");
			}
			if (!phone) {
				isValid = false;
				errorMessages.push("Phone is required for a primary guest.");
			}
			if (!email) {
				isValid = false;
				errorMessages.push("Email is required for a primary guest.");
			}
			if (!proofTypeId) {
				isValid = false;
				errorMessages.push("Type of Proof is required for a primary guest.");
			}
			if (!proofNumber) {
				isValid = false;
				errorMessages.push("Proof Number is required for a primary guest.");
			}
		}

		if (!isValid) {
			alert(errorMessages.join('\n'));
			return;
		}

		// Continue with AJAX only if validation passed
		const guestDto = {
			id: $('#guestId').val() || 0,
			isPrimary: isPrimary,
			fullName: fullName,
			email: $('#Email').val(),
			phone: $('#Phone').val(),
			proofTypeId: $('#proofTypeSelect').val(), // ✅ FIX
			proofTypeName: $('#proofTypeSelect option:selected').text(),
			proofNumber: $('#ProofNumber').val(),
			dateOfBirth: $('#DateOfBirth').val(),
			address: $('#Address').val(),
			branchId: $('#BranchId').val()
		};

		$.ajax({
			url: '/Guest/AddOrEditGuest',
			type: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(guestDto),
			success: function (response) {
				if (response.success) {
					const guestId = response.guestId;

					if (isPrimary) {
						reservationGuestList = reservationGuestList.filter(g => !g.isPrimary);
					}

					reservationGuestList = reservationGuestList.filter(g => g.guestId !== guestId);

					reservationGuestList.push({
						guestId: guestId,
						isPrimary: isPrimary
					});

					guestList = guestList.filter(g => g.id !== guestId);
					guestList.push({ ...guestDto, id: guestId });

					updateGuestTable();
					renderGuestList();

					form[0].reset();
					$('#guestId').val(0);
					$('#isPrimary').prop('checked', false);
					form.validate().resetForm();
					$('#proofTypeSelect').val('').trigger('change');

					toastr.success("Guest added successfully.");
				} else {
					Swal.fire("Error", response.message, "error");
				}
			},
			error: function () {
				Swal.fire("Error", "Failed to save guest. Please try again.", "error");
			}
		});
	});

	function updateGuestTable() {
		const tbody = $('#normalGuestTable tbody');
		tbody.empty();

		const normalGuests = guestList.filter(g => !g.isPrimary);
		guestCounter = normalGuests.length;
		$('#guestCount').text(guestCounter);

		normalGuests.forEach(guest => {
			tbody.append(`
					<tr data-guest-id="${guest.id}">
						<td>${guest.fullName}</td>
						<td>${guest.email}</td>
						<td>${guest.phone}</td>
						<td>
							<a type="button" class="text-teal-600 editGuestBtn"><i class="icon-pencil7"></i></a>
							<a type="button" class="text-danger deleteGuestBtn"><i class="icon-trash"></i></a>
						</td>
					</tr>
				`);
		});

		const primary = guestList.find(g => g.isPrimary);
		if (primary) {
			$('#primaryGuestContainer').html(`
					<div class="row">
						<div class="col-md-2">
							<img src="/assets/images/placeholder.jpg" class="img-circle img-md" alt="">
						</div>
						<div class="col-md-10">
							<h5 class="text-primary">${primary.fullName}</h5>
							<p>Email: ${primary.email}</p>
							<p>Phone: ${primary.phone}</p>
						</div>
					</div>
				`);
		} else {
			$('#primaryGuestContainer').html(`<p class="text-muted">No primary guest selected.</p>`);
		}
	}

	function renderGuestList() {
		const container = $('#guestDisplayList');
		container.empty();

		$('#guestCountLabel').text(`${guestList.length} guest${guestList.length !== 1 ? 's' : ''}`);
		$('#guestCount').text(guestList.filter(g => !g.isPrimary).length);

		guestList.forEach(guest => {
			const isPrimary = guest.isPrimary;
			const badge = isPrimary ? `<span class="label label-primary">Primary Guest</span>` : '';

			container.append(`
					<li class="media">
						<a href="#" class="media-left">
							<img src="/assets/images/placeholder.jpg" class="img-circle img-md" alt="">
						</a>
						<div class="media-body">
							<a href="#" class="media-heading text-default">
								${guest.fullName} ${badge}
							</a>
							<span class="text-size-small text-muted display-block">
								<span class="status-mark ${isPrimary ? 'border-primary' : 'border-success'} position-left"></span>
								${guest.email}
							</span>
						</div>
						<div class="media-right media-middle">
							<ul class="icons-list text-nowrap">
								<li><a href="#" class="editGuestBtn" data-id="${guest.id}"><i class="icon-pencil7"></i></a></li>
								<li><a href="#" class="deleteGuestBtn" data-id="${guest.id}"><i class="icon-trash"></i></a></li>
							</ul>
						</div>
					</li>
				`);
		});
	}

	// Edit guest
	$(document).on('click', '.editGuestBtn', function () {
		var guestId = $(this).data('id') || $(this).closest('tr').data('guest-id');
		var guest = guestList.find(g => g.id == guestId);
		if (!guest) return;

		$('#guestId').val(guest.id);
		$('#isPrimary').prop('checked', guest.isPrimary);
		$('#FullName').val(guest.fullName);
		$('#Email').val(guest.email);
		$('#Phone').val(guest.phone);
		$('#TypeOfProof').val(guest.typeOfProof);
		$('#ProofNumber').val(guest.proofNumber);
		$('#DateOfBirth').val(guest.dateOfBirth);
		$('#Address').val(guest.address);
	});

	// Delete guest
	$(document).on('click', '.deleteGuestBtn', function () {
		var guestId = $(this).data('id') || $(this).closest('tr').data('guest-id');

		guestList = guestList.filter(g => g.id != guestId);
		reservationGuestList = reservationGuestList.filter(g => g.guestId != guestId);

		updateGuestTable(); // remove from AddGuest tab
		renderGuestList();  // remove from Confirm tab
	});

	// Clear guest form manually
	$('#clearGuestForm').click(function () {
		$('#guestForm')[0].reset(); // Reset native form

		// Clear select2 fields
		$('#proofTypeSelect').val(null).trigger('change');

		// Reset hidden and checkbox fields
		$('#guestId').val('');
		$('#isPrimary').prop('checked', false);

		// Clear client-side validation
		$('#guestForm').validate().resetForm();
	});
</script>


