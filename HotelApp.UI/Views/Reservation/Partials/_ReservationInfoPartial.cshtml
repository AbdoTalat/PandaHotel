@model ReservationInfoDTO

<div class="row">

    <form id="bookRoomForm">
        <input type="hidden" id="ReservationId" value="@Model.ReservationId" />
        <input type="hidden" id="reservationNumber" value="@Model.ReservationNumber" />
        <div class="row">

            <!-- ================= Stay Information ================= -->
            <div class="col-md-12">
                <legend class="text-semibold">
                    <i class="icon-calendar22 position-left"></i> Stay Information
                </legend>
                <div class="row">
                    <!-- Check-in -->
                    <div class="col-md-5">
                        <label>Check-In <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="icon-calendar22"></i></span>
                            <input type="text" autocomplete="off"
                                   class="form-control daterange-time"
                                   id="CheckInVisible"
                                   placeholder="Check-in Date"
                                   value="@(Model.CheckInDate.HasValue
                                                               ? Model.CheckInDate.Value.ToString("dd/MM/yyyy hh:mm tt")
                                                               : string.Empty)" />
                            <input type="hidden" asp-for="CheckInDate" id="CheckInDate" />
                        </div>
                        <span asp-validation-for="CheckInDate" class="text-danger validation-error-label"></span>
                    </div>

                    <!-- Nights -->
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Nights</label>
                            <input type="text" class="form-control" asp-for="NumOfNights" id="NumOfNights" placeholder="Nights" readonly
                                   value="@(Model.CheckInDate.HasValue && Model.CheckOutDate.HasValue
                                                           ? Math.Floor((Model.CheckOutDate.Value - Model.CheckInDate.Value).TotalDays).ToString()
                                                           : string.Empty)" />
                            <span asp-validation-for="NumOfNights" class="text-danger validation-error-label"></span>
                        </div>
                    </div>

                    <!-- Check-out -->
                    <div class="col-md-5">
                        <label>Check-Out <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="icon-calendar22"></i></span>
                            <input type="text" autocomplete="off"
                                   class="form-control"
                                   id="CheckOutVisible"
                                   placeholder="Check-out Date"
                                   value="@(Model.CheckOutDate.HasValue
                                                               ? Model.CheckOutDate.Value.ToString("dd/MM/yyyy hh:mm tt")
                                                               : string.Empty)"
                                   readonly />
                            <input type="hidden" asp-for="CheckOutDate" id="CheckOutDate" />
                        </div>
                        <span asp-validation-for="CheckOutDate" class="text-danger validation-error-label"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Reservation Source <span class="text-danger">*</span></label>
                            <select asp-for="ReservationSourceId" asp-items="@Model.ReservationSources" id="reservationSourceSelect" class="form-control select" required data-placeholder="Reservation Source">
                                    <option value=""></option>
                            </select>
                            <span asp-validation-for="ReservationSourceId" class="text-danger validation-error-label"></span>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Company</label>
                            <div class="form-group has-feedback">
                                <input type="text" class="form-control" id="selectedCompanyName" readonly placeholder="Select Company..." data-toggle="modal" data-target="#companyModal">
                                <div class="form-control-feedback">
                                    <i class="icon-search4 text-size-base"></i>
                                </div>
                            </div>
                            <input type="hidden" asp-for="CompanyId" id="CompanyId" />
                            <span asp-validation-for="CompanyId" class="text-danger validation-error-label"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= Room Information ================= -->
            <div class="col-md-12">
                <legend class="text-semibold">
                    <i class="icon-home4 position-left"></i> Rooms Information
                </legend>

                <div class="form-group">
                    <label class="display-block text-semibold">Reservation Type</label>
                    <label class="radio-inline">
                        <input type="radio" id="singleBtn" name="reservationType" checked class="styled border-teal text-teal-600" value="single">
                        Single
                    </label>

                    <label class="radio-inline">
                        <input type="radio" id="groupBtn" name="reservationType" class="styled border-teal text-teal-600" value="group">
                        Group
                    </label>
                </div>
                <div class="table-responsive">
                    <table class="table table-xxs table-bordered" id="roomTable">
                        <thead>
                            <tr class="active">
                                <th class="col-lg-2">Room Type</th>
                                <th class="col-lg-1">No. of Rooms</th>
                                <th class="col-lg-1">Adults</th>
                                <th class="col-lg-1">Children</th>
                                <th class="col-lg-4">Rooms</th>
                                <th class="col-lg-1"></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <span asp-validation-for="RoomTypeToBookDTOs" class="text-danger validation-error-label"></span>

                <div id="addRoomWrapper" style="margin-top:10px;">
                    <button type="button" id="addRoomBtn" class="btn text-teal-800 border-teal btn-flat">
                        <i class="icon-plus22 position-left"></i> Add Room
                    </button>
                </div>

                <div class="row" style="margin-top:30px;">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>Rate <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select id="rateSelect" asp-for="RateId" data-selected="@Model?.RateId" name="RateId" class="form-control select" required data-placeholder="Choose Rate">
                                    <option></option>
                                </select>
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#rateModal">
                                        <i class="icon-info22 text-size-base"></i> Rate Details
                                    </button>
                                </div>
                            </div>
                            <span asp-validation-for="RateId" class="text-danger validation-error-label"></span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>


<div id="rateModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h5 class="modal-title">Rooms Charges Summary</h5>
            </div>

            <div class="modal-body">
                <div class="panel panel-flat">
                    <div id="rateDetails"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>
<div id="companyModal" class="modal fade in" style="display: none; padding-right: 15px;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h5 class="modal-title">Company</h5>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>Serach company </label>
                            <select id="companySelect" class="form-control select" data-placeholder="Search by company name...">
                                <option></option>
                            </select>
                        </div>
                    </div>
                </div>
                <form id="companyForm">
                    <input type="hidden" id="CompanyIdHidden" value="0" />

                    <div class="panel panel-flat border-left-sm border-left-teal ">
                        <div class="panel-body">
                            <div class="content">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyName">Name <span class="text-danger">*</span></label>
                                            <input type="text" id="CompanyName" name="CompanyName" class="form-control" required />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyPhone">Phone <span class="text-danger">*</span></label>
                                            <input type="text" id="CompanyPhone" name="CompanyPhone" class="form-control" required />
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyAddress">Address</label>
                                            <input type="text" id="CompanyAddress" name="CompanyAddress" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyEmail">Email</label>
                                            <input type="text" id="CompanyEmail" name="CompanyEmail" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="CompanyNotes">Notes</label>
                                            <textarea id="CompanyNotes" name="CompanyNotes" class="form-control" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="button" class="btn btn-link" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn bg-teal-400" id="saveCompanySelection">Save</button>

                    </div>
                </form>
            </div>
        </div>
    </div>
</div>




<script>
    $(function () {
        const $companySelect = $('#companySelect');
        const $companyForm = $('#companyForm');

        // ======== Select2 Setup ========
        $companySelect.select2({
            placeholder: "Search company...",
            minimumInputLength: 4,
            ajax: {
                url: '/Company/GetSerachedCompaniesByName',
                dataType: 'json',
                delay: 250,
                data: params => ({ name: params.term }),
                processResults: data => ({
                    results: data.map(c => ({ id: c.id, text: c.displayText }))
                })
            }
        });

        // ======== Preload Company (Edit Mode) ========
        const existingCompanyId = $('#CompanyId').val();
        if (existingCompanyId && existingCompanyId !== "0") {
            $.get(`/Company/GetSerachedCompanyData/${existingCompanyId}`)
                .done(c => {
                    $('#selectedCompanyName').val(c.name);
                    $('#CompanyIdHidden').val(c.id);
                })
                .fail(() => console.warn('⚠️ Failed to preload company for edit mode.'));
        }

        // ======== When company selected from search ========
        $companySelect.on('select2:select', e => {
            const id = e.params.data.id;
            $.get(`/Company/GetSerachedCompanyData/${id}`)
                .done(c => {
                    $('#CompanyIdHidden').val(c.id);
                    $('#CompanyName').val(c.name);
                    $('#CompanyPhone').val(c.phone);
                    $('#CompanyAddress').val(c.address);
                    $('#CompanyEmail').val(c.email);
                    $('#CompanyNotes').val(c.notes);
                })
                .fail(() => alert('⚠️ Failed to fetch company details'));
        });

        // ======== Save company in modal ========
        $companyForm.on('submit', function (e) {
            e.preventDefault();

            const dto = {
                Id: $('#CompanyIdHidden').val() || 0,
                Name: $('#CompanyName').val() || null,
                Phone: $('#CompanyPhone').val() || null,
                Address: $('#CompanyAddress').val() || null,
                Email: $('#CompanyEmail').val() || null,
                Notes: $('#CompanyNotes').val() || null
            };

            $.ajax({
                url: '/Company/SaveCompany',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dto)
            })
                .done(res => {
                    if (res.success) {
                        $('#selectedCompanyName').val(res.name);
                        $('#CompanyId').val(res.companyId);

                        $('#companyModal').modal('hide');
                        $companyForm[0].reset();
                        $('#CompanyIdHidden').val('');
                        $companySelect.val(null).trigger('change');
                    } else {
                        alert('⚠️ Error saving company');
                    }
                })
                .fail(() => alert('⚠️ Server error while saving company'));
        });
    });
</script>

<script>
    $("#bookRoomForm").on("submit", function (e) {
        e.preventDefault();

        const companyIdVal = $("#CompanyId").val();
        const formData = {
            ReservationId: $("#ReservationId").val(),
            CheckInDate: $("#CheckInDate").val(),
            CheckOutDate: $("#CheckOutDate").val(),
            NumOfNights: $("#NumOfNights").val(),
            ReservationNumber: $("#reservationNumber").val(),
            ReservationSourceId: $("#reservationSourceSelect").val(),
            RateId: $("#rateSelect").val(),
            CompanyId: companyIdVal ? parseInt(companyIdVal) : null,
            RoomTypeToBookDTOs: []
        };

        // ✅ Extract selected room types and room IDs from the dynamic table
        $("#roomTable tbody tr").each(function () {
            const roomTypeId = $(this).find(".room-type-select").val();
            const numOfRooms = $(this).find(".num-rooms-select").val();
            const numAdults = $(this).find(".num-adults-select").val();
            const numChildren = $(this).find(".num-children-select").val();
            const selectedRoomIds = $(this).find(".rooms-select").val() || [];

            if (roomTypeId && numOfRooms > 0) {
                formData.RoomTypeToBookDTOs.push({
                    RoomTypeId: parseInt(roomTypeId),
                    NumOfRooms: parseInt(numOfRooms),
                    NumOfAdults: parseInt(numAdults || 0),
                    NumOfChildrens: parseInt(numChildren || 0),
                    RoomIds: selectedRoomIds.map(id => parseInt(id))
                });
            }
        });

        //console.log("Submitting form data:", formData); // For debugging

        $.ajax({
            url: '/Reservation/SavReservationInfo',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (response) {
                if (response.success) {
                    toastr.success(response.message, 'Success');

                    // Confirmation info
                    $("#confirmCheckIn").text(formData.CheckInDate);
                    $("#confirmCheckOut").text(formData.CheckOutDate);

                    const checkIn = new Date(formData.CheckInDate);
                    const checkOut = new Date(formData.CheckOutDate);
                    const nights = $('#NumOfNights').val();
                    $("#confirmNights").text(nights);

                    if (response.amount) {
                        $("#confirmAmount").text(response.amount + " EGP");
                    }

                    $(document).trigger("roomBookingSuccess");

                    // Redirect to edit page if this was an add operation and we got a reservation ID back
                    if (response.reservationId && !formData.ReservationId) {
                        setTimeout(() => {
                            window.location.href = '/Reservation/Edit/' + response.reservationId;
                        }, 1500);
                    }
                } else {
                    showAlert('error', 'Validation Error', response.message || 'Failed to save reservation.');
                }
            },
            error: function (xhr) {
                let errorMessage = "Failed to save room booking.";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                Swal.fire("Error", errorMessage, "error");
            }
        });
    });</script>

 <script>
    $(function () {
        let dateChangeInProgress = false;
        let cachedRoomTypes = [];

        // ======== Cached Elements ========
        const $rateSelect = $('#rateSelect');
        const $checkIn = $('#CheckInDate');
        const $checkOut = $('#CheckOutDate');
        const $modal = $('#rateModal');
        const $rateDetails = $('#rateDetails');
        const reservationId = '@Model.ReservationId';

        const modelRateId = '@Model.RateId';
        const prefillRooms = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RoomTypeToBookDTOs ?? []));

        // Use the correct format that matches your hidden inputs
        const modelCheckIn = '@(Model.CheckInDate.HasValue ? Model.CheckInDate.Value.ToString("yyyy-MM-ddTHH:mm") : "")';
        const modelCheckOut = '@(Model.CheckOutDate.HasValue ? Model.CheckOutDate.Value.ToString("yyyy-MM-ddTHH:mm") : "")';

        // ======== Form Submission Helper ========
        function collectRoomData() {
            const roomData = [];
            $('#roomTable tbody tr').each(function () {
                const $row = $(this);
                const roomTypeId = $row.find('.room-type-select').val();
                const numRooms = $row.find('.num-rooms-select').val();
                const numAdults = $row.find('.num-adults-select').val();
                const numChildren = $row.find('.num-children-select').val();
                const selectedRoomIds = $row.find('.rooms-select').val() || [];

                if (roomTypeId && numRooms) {
                    roomData.push({
                        RoomTypeId: parseInt(roomTypeId),
                        NumOfRooms: parseInt(numRooms),
                        NumOfAdults: parseInt(numAdults),
                        NumOfChildrens: parseInt(numChildren),
                        RoomIds: selectedRoomIds.map(id => parseInt(id))
                    });
                }
            });
            return roomData;
        }

        // ======== Add Button State Helper ========
        function checkAddButtonState() {
            const allRowsValid = $('#roomTable tbody tr').toArray().every(row => {
                const $row = $(row);
                const roomTypeId = $row.find('.room-type-select').val();
                return roomTypeId && roomTypeId !== '';
            });
            
            // Enable/disable the add button based on state
            $('#addRoomBtn').prop('disabled', !allRowsValid);
        }

        // ======== Date Picker Initialization ========
        function initializeDatePicker() {
            function clearDates() {
                dateChangeInProgress = true;
                $('#CheckInDate, #CheckOutDate, #NumOfNights').val('');
                $('#CheckInVisible, #CheckOutVisible').val('');
                dateChangeInProgress = false;

                // Clear room data when dates are cleared
                cachedRoomTypes = [];
                $('#roomTable tbody').empty();
                resetRates();
            }

            // Get current dates or set to undefined
            const currentCheckIn = $('#CheckInVisible').val() ? moment($('#CheckInVisible').val(), 'DD/MM/YYYY hh:mm A') : undefined;
            const currentCheckOut = $('#CheckOutVisible').val() ? moment($('#CheckOutVisible').val(), 'DD/MM/YYYY hh:mm A') : undefined;

            $('.daterange-time').daterangepicker({
                timePicker: true,
                timePicker24Hour: false,
                autoUpdateInput: false,
                locale: {
                    cancelLabel: 'Clear',
                    format: 'DD/MM/YYYY hh:mm A'
                },
                applyClass: 'bg-slate-600',
                cancelClass: 'btn-default',
                startDate: currentCheckIn,
                endDate: currentCheckOut,
                minDate: moment()
            });

            $('.daterange-time').on('apply.daterangepicker', function (ev, picker) {
                const checkIn = picker.startDate;
                const checkOut = picker.endDate;

                if (!checkIn || !checkOut || checkIn >= checkOut) {
                    showAlert('error', 'Invalid Dates', 'Check-out must be after check-in.');
                    clearDates();
                    return;
                }

                dateChangeInProgress = true;

                // Update hidden fields (API format)
                $('#CheckInDate').val(checkIn.format('YYYY-MM-DDTHH:mm'));
                $('#CheckOutDate').val(checkOut.format('YYYY-MM-DDTHH:mm'));

                // Update visible fields (display format)
                $('#CheckInVisible').val(checkIn.format('DD/MM/YYYY hh:mm A'));
                $('#CheckOutVisible').val(checkOut.format('DD/MM/YYYY hh:mm A'));

                const nights = Math.floor(checkOut.diff(checkIn, 'days', true));
                $('#NumOfNights').val(nights);

                dateChangeInProgress = false;

                // Load available room types
                loadAvailableRoomTypesAfterDateChange();
            });

            $('.daterange-time').on('cancel.daterangepicker', function () {
                clearDates();
            });
        }

        // ======== Room Loading After Date Change ========
        function loadAvailableRoomTypesAfterDateChange() {
            const checkIn = $checkIn.val();
            const checkOut = $checkOut.val();

            if (!checkIn || !checkOut) {
                toastr.warning("Please select both Check-In and Check-Out dates first.");
                return;
            }

            cachedRoomTypes = [];
            $('#roomTable tbody').empty();

            loadAvailableRoomTypes(() => {
                // For edit mode, restore pre-filled rooms, otherwise add empty row
                if (prefillRooms.length > 0) {
                    prefillRooms.forEach(r => addRoomRow(r));
                } else {
                    addRoomRow();
                }
                updateRates();
            }, true);
        }

        // ======== Utility Helpers ========
         function fillOptions($select, start, end, selected = null) {
        $select.empty().append('<option></option>');
        for (let i = start; i <= end; i++) {
            $select.append($('<option>', {
                value: i,
                text: i
            }));
        }
        // Accept 0 as a valid selection (don't use truthy check)
        if (selected !== null && selected !== undefined) {
            $select.val(selected).trigger('change.select2');
        }
    }


        function updateRowCapacities($row) {
            debugger;
            const opt = $row.find('.room-type-select option:selected');
            if (!opt.length) return;

            const maxRooms = +opt.data('count') || 0;
            const maxAdults = +opt.data('maxAdults') || 0;
            const maxChildren = +opt.data('maxChildren') || 0;
            const $numRooms = $row.find('.num-rooms-select');
            const $adults = $row.find('.num-adults-select');
            const $children = $row.find('.num-children-select');

            const rooms = +$numRooms.val() || 1;

            fillOptions($numRooms, 1, maxRooms, rooms);
            fillOptions($adults, 1, maxAdults * rooms, +$adults.val() || 1);
            fillOptions($children, 0, maxChildren * rooms, +$children.val() || 0);
        }

        function refreshAllRoomTypeOptions() {
            debugger;
            const allSelects = $('.room-type-select');
            const selected = allSelects.map((_, el) => $(el).val()).get().filter(Boolean);

            allSelects.each(function () {
                const $select = $(this);
                const current = $select.val();

                // Rebuild full options list so every select has the same DOM options.
                let optionsHtml = '<option></option>';
                if (cachedRoomTypes.length) {
                    cachedRoomTypes.forEach(rt => {
                        debugger;
                        const val = rt.id.toString();
                        const isUnavailable = Number(rt.numOfAvailableRooms) === 0;
                        const selectedElsewhere = val && val !== current && selected.includes(val);
                        const shouldDisable = isUnavailable || selectedElsewhere;
                        const availableText = isUnavailable ? `(Unavailable)` : `(${rt.numOfAvailableRooms} Available)`;
                        const disabledAttr = shouldDisable ? 'disabled' : '';

                        optionsHtml += `
                            <option value="${rt.id}" ${disabledAttr}
                                    data-name="${rt.name}"
                                    data-count="${rt.numOfAvailableRooms}"
                                    data-max-adults="${rt.maxNumOfAdults}"
                                    data-max-children="${rt.maxNumOfChildrens}">
                                ${rt.name} ${availableText}
                            </option>`;
                    });
                }

                // Safely update Select2: destroy, replace options, restore value, reinit
                try { $select.select2('destroy'); } catch (e) { /* ignore if not initialized */ }
                $select.html(optionsHtml);

                // Keep current value if present (even if disabled) so edit mode stays consistent.
                if (current) {
                    $select.val(current);
                }

                $select.select2({
                    width: '100%',
                    placeholder: "Select Room Type"
                });
            });
        }

        function updateRemoveButtons() {
            const rows = $('#roomTable tbody tr');
            rows.find('.remove-room-btn').toggle(rows.length > 1);
        }

        // ======== Room Selection Functions ========
        function initializeRoomSelect($select, roomTypeId = null, prefillRoomIds = []) {
            // Store roomTypeId in the element data for later use
            $select.data('roomTypeId', roomTypeId);

            $select.select2({
                placeholder: "Search & select available rooms...",
                minimumInputLength: 2,
                multiple: true,
                ajax: {
                    url: '/Room/GetAvailableRooms',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            name: params.term,
                            roomTypeId: roomTypeId,
                            checkInDate: $checkIn.val(),
                            checkOutDate: $checkOut.val(),
                            reservationId: reservationId
                        };
                    },
                    processResults: function (data) {
                        if (data.success) {
                            return {
                                results: data.data
                            };
                        }
                        return { results: [] };
                    },
                    cache: true
                }
            });

            // Preselect rooms if provided
            if (prefillRoomIds && prefillRoomIds.length > 0) {
                setTimeout(() => {
                    loadAndPreselectRooms($select, prefillRoomIds);
                }, 200);
            }
        }

        function loadAndPreselectRooms($select, roomIds) {
            if (!roomIds || roomIds.length === 0) return;

            $.ajax({
                url: '/Room/GetRoomsForEditReservationByIDs',
                type: 'GET',
                data: { ids: roomIds },
                traditional: true,
                success: function (data) {
                    if (data.success && Array.isArray(data.data)) {
                        // Clear any existing options
                        $select.empty();
                        
                        // Add and select the rooms
                        data.data.forEach(room => {
                            const option = new Option(room.text, room.id, true, true);
                            $select.append(option);
                        });
                        
                        // Trigger change to update Select2 UI
                        $select.trigger('change');
                    }
                },
                error: function (xhr) {
                    console.error('Failed to load pre-selected rooms:', xhr.responseText);
                }
            });
        }

        function updateRoomSelection($row) {
            const roomTypeId = $row.find('.room-type-select').val();
            const $roomSelect = $row.find('.rooms-select');

            if (roomTypeId) {
                // Update the stored roomTypeId
                $roomSelect.data('roomTypeId', roomTypeId);

                // Store current selection before reinitializing
                const selectedRooms = $roomSelect.val();
                
                // Destroy and reinitialize the select2 with new roomTypeId
                $roomSelect.select2('destroy');
                initializeRoomSelect($roomSelect, roomTypeId, selectedRooms);
            }
        }

        // ======== Room Row Management ========
        function loadAvailableRoomTypes(callback, forceReload = false) {
        const checkIn = $checkIn.val();
        const checkOut = $checkOut.val();

        if (!checkIn || !checkOut) {
            if (callback) callback([]);
            return;
        }

        if (cachedRoomTypes.length && !forceReload) {
            if (callback) callback(cachedRoomTypes);
            return;
        }

        $.ajax({
            url: '/Reservation/GetAvailableRoomTypes',
            type: 'GET',
            data: {
                checkInDate: checkIn,
                checkOutDate: checkOut,
                reservationId: reservationId // Make sure reservationId is defined in scope
            },
            success: function (data) {
                cachedRoomTypes = data || [];
                if (callback) callback(cachedRoomTypes);
            },
            error: xhr => {
                console.error(xhr.responseText);
                toastr.error("Failed to load available room types.");
                if (callback) callback([]);
            }
        });
    }


        function addRoomRow(prefill = null) {
            debugger;
            const checkIn = $checkIn.val();
            const checkOut = $checkOut.val();

            // For edit mode with prefill data, we don't need dates to be set yet
            if (!prefill && (!checkIn || !checkOut)) {
                toastr.warning("Please select Check-In and Check-Out dates first.");
                return;
            }

            // Check if all previous rows have room type selected (only for new rows, not prefill)
            if (!prefill) {
                const previousRowsValid = $('#roomTable tbody tr').toArray().every(row => {
                    const $row = $(row);
                    const roomTypeId = $row.find('.room-type-select').val();
                    return roomTypeId && roomTypeId !== '';
                });
                
                if (!previousRowsValid) {
                    toastr.warning("Please select room type for all existing rows before adding a new row.");
                    return;
                }
            }

            // If we have prefill data but no cached room types, we need to load them first
            if (prefill && !cachedRoomTypes.length && checkIn && checkOut) {
                loadAvailableRoomTypes(() => {
                    addRoomRowWithData(prefill);
                }, true);
                return;
            }
            debugger;
            addRoomRowWithData(prefill);
        }

    function addRoomRowWithData(prefill = null) {
           let optionsHtml = '<option></option>';

           if (cachedRoomTypes.length) {
               cachedRoomTypes.forEach(rt => {
                   const availableText = rt.numOfAvailableRooms > 0
                       ? `(${rt.numOfAvailableRooms} Available)`
                       : `(Unavailable)`;
                   optionsHtml += `
                       <option value="${rt.id}"
                               data-name="${rt.name}"
                               data-count="${rt.numOfAvailableRooms}"
                               data-max-adults="${rt.maxNumOfAdults}"
                               data-max-children="${rt.maxNumOfChildrens}">
                           ${rt.name} ${availableText}
                       </option>`;
               });
           }

           const $newRow = $(`
               <tr>
                   <td><select class="form-control select room-type-select" data-placeholder="Room Type">${optionsHtml}</select></td>
                   <td><select class="form-control select num-rooms-select" data-placeholder="Rooms"></select></td>
                   <td><select class="form-control select num-adults-select" data-placeholder="Adults"></select></td>
                   <td><select class="form-control select num-children-select" data-placeholder="Children"></select></td>
                   <td><select class="form-control rooms-select" multiple="multiple"></select></td>
                   <td><button type="button" class="btn btn-default btn-sm remove-room-btn"><i class="icon-x"></i></button></td>
               </tr>
           `);

           $('#roomTable tbody').append($newRow);
           initializeRow($newRow, prefill);

           if (prefill) {
               // Deterministic sequence to avoid race conditions:
               // 1) set room-type so change handler sets capacities & initializes rooms-select
               $newRow.find('.room-type-select').val(prefill.RoomTypeId).trigger('change');

               // 2) after capacity population, set number of rooms (recomputes adults/children ranges)
               setTimeout(() => {
                   if (prefill.NumOfRooms !== undefined && prefill.NumOfRooms !== null) {
                       $newRow.find('.num-rooms-select').val(prefill.NumOfRooms).trigger('change');
                   }

                   // 3) after num-rooms change finishes, set adults/children (0 is valid)
                   setTimeout(() => {
                       if (prefill.NumOfAdults !== undefined && prefill.NumOfAdults !== null) {
                           $newRow.find('.num-adults-select').val(prefill.NumOfAdults).trigger('change');
                       }
                       if (prefill.NumOfChildrens !== undefined && prefill.NumOfChildrens !== null) {
                           $newRow.find('.num-children-select').val(prefill.NumOfChildrens).trigger('change');
                       }

                       // 4) finally preload the actual room IDs into the rooms-select
                       const $roomsSelect = $newRow.find('.rooms-select');
                       if (Array.isArray(prefill.RoomIds) && prefill.RoomIds.length) {
                           // ensure the rooms-select is initialized with correct roomTypeId and then preselect
                           initializeRoomSelect($roomsSelect, prefill.RoomTypeId, prefill.RoomIds);
                       }
                   }, 80);
               }, 80);
           }

           updateRemoveButtons();
           refreshAllRoomTypeOptions();
           updateRates();
           checkAddButtonState();
       }
        function removeRoomRow(btn) {
            $(btn).closest('tr').remove();
            updateRemoveButtons();
            refreshAllRoomTypeOptions();
            updateRates();
            checkAddButtonState();
        }

    function initializeRow($row, prefill = null) {
           const $roomTypeSelect = $row.find('.room-type-select');
           const $roomSelect = $row.find('.rooms-select');
           const prefillRoomIds = prefill ? prefill.RoomIds : [];

           $roomTypeSelect.select2({
               width: '100%',
               placeholder: "Select Room Type"
           }).on('change', function () {
               updateRowCapacities($(this).closest('tr'));
               updateRoomSelection($(this).closest('tr'));
               refreshAllRoomTypeOptions();
               updateRates();
               checkAddButtonState();
           });

           $row.find('.num-rooms-select').select2({ width: '100%' })
               .on('change', function () {
                   updateRowCapacities($(this).closest('tr'));
                   updateRates();
               });

           $row.find('.num-adults-select, .num-children-select').select2({ width: '100%' });

           // Initialize room selection with the actual room type ID and pre-filled room IDs
           const initialRoomTypeId = prefill ? prefill.RoomTypeId : null;
           initializeRoomSelect($roomSelect, initialRoomTypeId, prefillRoomIds);

           // If options are already present (edit mode), ensure capacities reflect current selections
           // run once to populate num/adult/child selects when row is created.
           setTimeout(() => updateRowCapacities($row), 30);
       }
        // ======== Rates Handling ========
        function updateRates() {
            const roomTypeIds = $('#roomTable .room-type-select').map((_, el) => $(el).val()).get().filter(Boolean);
            if (!roomTypeIds.length || !$checkIn.val() || !$checkOut.val()) {
                resetRates();
                return;
            }

            $.ajax({
                url: '/Rate/GetRatesByRoomTypes',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    RoomTypeIds: roomTypeIds,
                    CheckInDate: new Date($checkIn.val()),
                    CheckOutDate: new Date($checkOut.val())
                })
            })
            .done(rates => {
                $rateSelect.empty().append(new Option('Select Rate', '', false, false));
                rates.forEach(rate => {
                    const types = rate.roomTypeRateForReservations.map(rt => `${rt.typeName} ($${rt.dailyPrice})`).join(' - ');
                    const optionText = `${rate.name}|||${types}`;
                    $rateSelect.append(new Option(optionText, rate.id, false, false));
                });
                $rateSelect.select2({
                    width: '100%',
                    placeholder: "Choose Rate",
                    templateResult: formatRateOption,
                    templateSelection: formatRateOption
                });
                if (modelRateId) $rateSelect.val(modelRateId).trigger('change');
            })
            .fail(() => resetRates());
        }

        function resetRates() {
            $rateSelect.empty().append(new Option('Select Rate', '', false, false)).val(null).trigger('change');
            $rateDetails.empty().hide();
        }

        function formatRateOption(option) {
            if (!option.id) return option.text;
            const [name, types] = option.text.split('|||');
            return $(`<div><b class="text-success">${name}</b> <small>- ${types}</small></div>`);
        }

        function loadRateDetails() {
            const rateId = $rateSelect.val();
            const checkIn = $checkIn.val();
            const checkOut = $checkOut.val();

            if (!rateId || !checkIn || !checkOut) {
                $rateDetails.html('<p class="text-danger">Please select a rate, check-in, and check-out.</p>').show();
                return;
            }

            const roomTypeQuantities = $('#roomTable tbody tr').map(function () {
                const roomTypeId = $(this).find('.room-type-select').val();
                const qty = $(this).find('.num-rooms-select').val();
                return roomTypeId && qty ? { RoomTypeId: +roomTypeId, Quantity: +qty } : null;
            }).get();

            if (!roomTypeQuantities.length) {
                $rateDetails.html('<p class="text-danger">Please add at least one room.</p>').show();
                return;
            }

            $.ajax({
                url: '/Rate/GetReservationChargesSummary',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    RateId: +rateId,
                    CheckIn: new Date(checkIn),
                    CheckOut: new Date(checkOut),
                    ReservationId: +reservationId,
                    roomTypeQuantities
                })
            })
            .done(res => {
                if (!res.success || !res.data) {
                    $rateDetails.html(`<p class="text-danger">${res.message || 'No calculation available.'}</p>`).show();
                    return;
                }

                const summary = res.data.chargesSummary;
                let html = `<div>`;

                // --- RATE TYPES TABLE ---
                html += `
                <table class="table table-framed table-hover m-0">
                    <thead class="table-light">
                        <tr class="border-double active">
                            <th>RoomType/Charge</th>
                            <th>Rooms</th>
                            <th>Unit</th>
                            <th>Rate</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                summary.filter(x => x.type === 'Rate').forEach(item => {
                    const rowClass = item.charge === 'Total' ? 'success' : '';
                    html += `
                        <tr class="${rowClass}">
                            <td>${item.charge}</td>
                            <td>${item.rooms || ""}</td>
                            <td>${item.unit || ""}</td>
                            <td>${item.rate || ""}</td>
                            <td>${item.total}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table>  <br />`;

                // --- PAYMENTS TABLE ---
                html += `
                <table class="table table-framed table-hover m-0">
                    <thead class="table-light">
                        <tr class="border-double active">
                            <th>Payment Type</th>
                            <th colspan="4"></th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                summary.filter(x => x.type === 'Payment').forEach(item => {
                    const rowClass = item.charge === 'Total Payments' ? 'success' : '';
                    html += `
                        <tr class="${rowClass}">
                            <td>${item.charge}</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>${item.total}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;

                // --- BALANCE BOX ---
                const balanceItem = summary.find(x => x.type === 'Balance');
                if (balanceItem) {
                    html += `
                    <br />
                    <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-primary no-border">
                            <h5 class="text-semibold">Balance:</span> ${balanceItem.total}
                        </div></div>
                    </div>
                    `;
                }

                html += `</div>`; // container

                $rateDetails.html(html).show();
            })
            .fail(() => $rateDetails.html('<p class="text-danger">Error loading charges summary.</p>').show());
        }

        // ======== Event Bindings ========
        $('#addRoomBtn').on('click', function (e) { 
            e.preventDefault(); 
            
            // Check if all previous rows have room type selected
            const allRowsValid = $('#roomTable tbody tr').toArray().every(row => {
                const $row = $(row);
                const roomTypeId = $row.find('.room-type-select').val();
                return roomTypeId && roomTypeId !== '';
            });
            
            if (!allRowsValid) {
                toastr.warning("Please select room type for all existing rows before adding a new row.");
                return;
            }
            
            addRoomRow(); 
        });
        
        $(document).on('click', '.remove-room-btn', function () { removeRoomRow(this); });
        $modal.on('show.bs.modal', loadRateDetails);
        $modal.on('click', '[data-action="reload"]', e => { e.preventDefault(); loadRateDetails(); });

        // ======== Initialize ========
        initializeDatePicker();

        // Initialize dates from model for edit mode
        if (modelCheckIn) {
            $('#CheckInDate').val(modelCheckIn);
            const displayCheckIn = moment(modelCheckIn).format('DD/MM/YYYY hh:mm A');
            $('#CheckInVisible').val(displayCheckIn);
        }
        if (modelCheckOut) {
            $('#CheckOutDate').val(modelCheckOut);
            const displayCheckOut = moment(modelCheckOut).format('DD/MM/YYYY hh:mm A');
            $('#CheckOutVisible').val(displayCheckOut);

            if (modelCheckIn) {
                const nights = moment(modelCheckOut).diff(moment(modelCheckIn), 'days');
                $('#NumOfNights').val(nights);
            }
        }
        debugger;
        // Initialize rooms
        if (prefillRooms.length) {
            debugger;
            // Edit mode - we have pre-filled rooms
            // Load room types first, then add pre-filled rows
            if ($checkIn.val() && $checkOut.val()) {
                loadAvailableRoomTypes(() => {
                    prefillRooms.forEach(r => addRoomRow(r));
                }, true);
            } else {
                // If no dates set, still add the rows but without room type options
                prefillRooms.forEach(r => addRoomRow(r));
            }
        } else {
            // Add mode - no pre-filled rooms
            if ($checkIn.val() && $checkOut.val()) {
                // Dates are set, load room types
                loadAvailableRoomTypes(() => {
                    addRoomRow();
                }, true);
            } else {
                // No dates set, add empty row
                const $defaultRow = $(`
                    <tr>
                        <td><select class="form-control select room-type-select" data-placeholder="Room Type"><option></option></select></td>
                        <td><select class="form-control select num-rooms-select" data-placeholder="Rooms"></select></td>
                        <td><select class="form-control select num-adults-select" data-placeholder="Adults"></select></td>
                        <td><select class="form-control select num-children-select" data-placeholder="Children"></select></td>
                        <td><select class="form-control rooms-select" multiple="multiple"></select></td>
                        <td><button type="button" class="btn btn-default btn-sm remove-room-btn" style="display:none;"><i class="icon-x"></i></button></td>
                    </tr>
                `);
                $('#roomTable tbody').append($defaultRow);
                initializeRow($defaultRow);
            }
        }

        updateRemoveButtons();
        checkAddButtonState();

        // Expose collectRoomData for form submission
        window.collectRoomData = collectRoomData;
        window.loadAvailableRoomTypesAfterDateChange = loadAvailableRoomTypesAfterDateChange;
    });
</script> 