﻿@{
	TempData["Title"] = "Add Reservation";

}
<div class="page-header page-header-default page-header-xs">
	<div class="page-header-content">
		<div class="page-title">
			<h4><i class="icon-arrow-left52 position-left"></i> <span class="text-semibold">Add Reservation</span> </h4>
		</div>
	</div>

	<div class="breadcrumb-line">
		<ul class="breadcrumb">
			<li><a href="index.html"><i class="icon-home2 position-left"></i> Home</a></li>
			<li><a asp-action="Index" asp-controller="Reservation">Reservations</a></li>
			<li class="active">Add Reservation</li>
		</ul>

		<ul class="breadcrumb-elements">
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">
					<i class="icon-gear position-left"></i>
					Settings
					<span class="caret"></span>
				</a>

				<ul class="dropdown-menu dropdown-menu-right">
					<li><a href="#"><i class="icon-user-lock"></i> Account security</a></li>
					<li><a href="#"><i class="icon-statistics"></i> Analytics</a></li>
					<li><a href="#"><i class="icon-accessibility"></i> Accessibility</a></li>
					<li class="divider"></li>
					<li><a href="#"><i class="icon-gear"></i> All settings</a></li>
				</ul>
			</li>
		</ul>
	</div>
</div>

<div class="content">
    <div class="panel">
        <div class="panel-body">
            <div class="tabbable tab-content-bordered">
                <ul class="nav nav-tabs nav-tabs-bottom nav-justified">
                    <li class="active"><a href="#tab1" data-toggle="tab" id="tab1-link">Reservation Details</a></li>
                    <li class="disabled"><a href="#tab2" id="tab2-link">Guest Information</a></li>
                    <li class="disabled"><a href="#tab3" id="tab3-link">Confirm</a></li>
                </ul>
            </div>

            <div class="tab-content">

                <div class="tab-pane active has-padding" id="tab1">
                    @await Html.PartialAsync("Partials/_ReservationInfoPartial", new ReservationInfoDTO())
                </div>

                <div class="tab-pane  has-padding" id="tab2">
                    <div id="guestTab">
                        @await Html.PartialAsync("Partials/_GuestInformationPartial")
                    </div>
                </div>

                <div class="tab-pane has-padding" id="tab3">
                    @await Html.PartialAsync("Partials/_ConfirmReservationPartial")
                </div>

            </div>

            <div class="text-center mt-3">
                <button type="button" id="prevBtn" class="btn btn-default me-2">
                    <i class="icon-arrow-left13 position-left"></i> Back
                </button>

                <button type="button" id="nextBtn" class="btn bg-primary">
                    Next <i class="icon-arrow-right14 position-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {

	<script>
		$(document).ready(function () {
			loadSelect("#proofTypeSelect", "/ProofType/GetProofTypesJson", "name", "id");
			loadSelect("#reservationSourceSelect", "/ReservationSource/GetReservationSourcesDropDown", "displayText", "id");
		});
	</script>

    <script>
        // ===== Permissions injected from server =====
        const userPermissions = {
            canManageStatus: @User.HasClaim("permission", "Reservation.ManageStatus").ToString().ToLower(),
            canConfirm: @User.HasClaim("permission", "Reservation.Confirm").ToString().ToLower(),
            canCheckIn: @User.HasClaim("permission", "Reservation.CheckIn").ToString().ToLower(),
            canPending: @User.HasClaim("permission", "Reservation.Pending").ToString().ToLower()
                                    };

        let currentTab = 1; // start from tab 1

        // ===== Main tab control =====
        function showTab(index) {
            $(".tab-pane").removeClass("show active");
            $(`#tab${index}`).addClass("show active");

            $(".nav-tabs li").removeClass("active").addClass("disabled");
            $(`#tab${index}-link`).parent("li").removeClass("disabled").addClass("active");

            // Show or hide Back button
            $("#prevBtn").toggle(index > 1);

            // Handle dynamic button rendering
            if (index === 3) {
                updateNextButtonLabel();
            } else {
                $("#nextBtn").replaceWith(`
                                                <button type="button" id="nextBtn" class="btn bg-teal-400">
                                                    Next <i class="icon-arrow-right14 position-right"></i>
                                                </button>
                                            `);
            }

            // Lazy load guest form
            if (index === 2 && $("#guestTab").is(':empty')) {
                $("#guestTab").load("/Guest/LoadGuestForm", initializeSelect2);
            }
        }

        // ===== Dynamically render Next/Submit buttons based on permission =====
        function updateNextButtonLabel() {
            if (userPermissions.canManageStatus) {
                $("#nextBtn").replaceWith(`
                                                <button type="button" id="nextBtn" class="btn bg-teal-400">
                                                    Submit
                                                </button>
                                            `);
            }
            else if (userPermissions.canConfirm && userPermissions.canCheckIn) {
                $("#nextBtn").replaceWith(`
                                                <button type="button" id="saveConfirmBtn" class="btn bg-blue-600 me-2">
                                                    Save & Confirm <i class="icon-checkmark4 position-right"></i>
                                                </button>
                                                <button type="button" id="saveCheckInBtn" class="btn bg-success-600">
                                                    Save & Check-In <i class="icon-user-check position-right"></i>
                                                </button>
                                            `);
            }
            else if (userPermissions.canConfirm) {
                $("#nextBtn").replaceWith(`
                                                <button type="button" id="nextBtn" class="btn bg-blue-600">
                                                    Save & Confirm <i class="icon-checkmark4 position-right"></i>
                                                </button>
                                            `);
            }
            else if (userPermissions.canCheckIn) {
                $("#nextBtn").replaceWith(`
                                                <button type="button" id="nextBtn" class="btn bg-success-600">
                                                    Save & Check-In <i class="icon-user-check position-right"></i>
                                                </button>
                                            `);
            }
            else {
                $("#nextBtn").replaceWith(`
                                                <button type="button" id="nextBtn" class="btn bg-teal-400">
                                                    Submit
                                                </button>
                                            `);
            }
        }

        // ===== Submit Reservation with chosen status =====
        function submitReservationWithStatus(options = {}) {
            const data = {
                Comment: $('#reservationComment').val(),
                IsPending: false,
                IsConfirmed: !!options.confirm,
                IsCheckedIn: !!options.checkIn,
                IsCheckedOut: false,
                IsCancelled: false,
                IsNoShow: false,
                CancellationReason: $('#cancellationReason').val()
            };

            if (userPermissions.canManageStatus) {
                data.IsPending = $('#isPending').is(':checked');
                data.IsConfirmed = $('#isConfirmed').is(':checked');
                data.IsCheckedIn = $('#isCheckedIn').is(':checked');
                data.IsCheckedOut = $('#isCheckedOut').is(':checked');
                data.IsCancelled = $('#isCancelled').is(':checked');
                data.IsNoShow = $('#isNoShow').is(':checked');
            } else if (!options.confirm && !options.checkIn) {
                data.IsPending = true;
            }

            $.ajax({
                type: "POST",
                url: "/Reservation/SubmitReservation",
                data: JSON.stringify(data),
                contentType: "application/json",
                success: function (res) {
                    if (res.success) window.location.href = "/Reservation/Index";
                    else showAlert('error', 'Error!', res.message);
                },
                error: function () {
                    Swal.fire("Error", "Failed to submit reservation.", "error");
                }
            });
        }

        // ===== Navigation logic =====
        function goNext() {
            if (currentTab === 1) {
                $("#bookRoomForm").submit();
            } else if (currentTab === 2) {
                $.ajax({
                    url: '/Guest/AddGuestsToReservation',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(reservationGuestList),
                    success: function (res) {
                        if (res.success) {
                            showToast('success', 'Success', res.message);
                            $(document).trigger("guestFormSuccess");
                        } else {
                            showAlert('error', 'Error!', res.message);
                        }
                    },
                    error: function () {
                        Swal.fire("Error", "Failed to save guests. Please try again.", "error");
                    }
                });
            } else if (currentTab === 3) {
                submitReservationWithStatus();
            }
        }

        function goPrev() {
            if (currentTab > 1) {
                currentTab--;
                showTab(currentTab);
            }
        }

        // ===== Init =====
        $(function () {
            showTab(currentTab);

            $(document).on("click", "#nextBtn", goNext);
            $(document).on("click", "#prevBtn", goPrev);
            $(document).on("click", "#saveConfirmBtn", function () {
                submitReservationWithStatus({ confirm: true });
            });
            $(document).on("click", "#saveCheckInBtn", function () {
                submitReservationWithStatus({ confirm: true, checkIn: true });
            });

            $(document).on("roomBookingSuccess", () => { currentTab++; showTab(currentTab); });
            $(document).on("guestFormSuccess", () => { currentTab++; showTab(currentTab); });

            $(".nav-tabs a").on("click", function (e) {
                if ($(this).parent("li").hasClass("disabled")) {
                    e.preventDefault();
                }
            });
        });
    </script>

    <script>
        $.validator.setDefaults({
            ignore: [] // include hidden fields in validation
        });
    </script>


	@await Html.PartialAsync("_ValidationScriptsPartial")
}