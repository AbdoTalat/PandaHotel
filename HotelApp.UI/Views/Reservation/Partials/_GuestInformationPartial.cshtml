@using System.Text.Json
@model List<ReservationGuestDTO>

@{
    int BranchId = ViewBag.BranchId;
}
<div class="row">
    <div class="col-md-8">

        @await Html.PartialAsync("Partials/_AddOrEditGuest", new GuestDTO())
    </div>
    <div class="col-md-4">
        <!-- Primary Guest Panel -->
        <div class="panel panel-flat">
            <div class="panel-heading">
                <h6 class="panel-title text-grey-400">Primary Guest</h6>

                <div class="heading-elements">
                    <a id="editPrimaryBtn" style="display:none;">
                        <i class="icon-pencil"></i> Edit
                    </a>
                </div>
            </div>

            <div class="panel-body" id="primaryGuestContainer">
                <!-- Primary guest info here -->
            </div>
        </div>

        <!-- Normal Guests Panel -->
        <div class="panel panel-flat panel-default">
            <div class="panel-heading">
                <h6 class="panel-title">
                    Guests (<span id="guestCount">0</span>)
                </h6>
            </div>
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table " id="normalGuestTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>

                    </table>
                </div>
            </div>
        </div>

    </div>

</div>



<script>
    (() => {
        // ========== INIT ==========
        const raw = @Html.Raw(JsonSerializer.Serialize(Model ?? new List<ReservationGuestDTO>()));

        window.guestList = Array.isArray(raw) ? raw.map(g => ({
            id: g.GuestId ?? g.id ?? 0,
            fullName: g.FullName ?? g.fullName ?? '',
            email: g.Email ?? g.email ?? '',
            phone: g.Phone ?? g.phone ?? '',
            address: g.Address ?? g.address ?? '',
            proofTypeId: g.ProofTypeId ?? g.proofTypeId ?? '',
            proofNumber: g.ProofNumber ?? g.proofNumber ?? '',
            dateOfBirth: g.DateOfBirth ?? g.dateOfBirth ?? '',
            isPrimary: !!(g.IsPrimary ?? g.isPrimary),
            branchId: @BranchId
            })) : [];

        window.reservationGuestList = window.guestList.map(g => ({
            guestId: g.id,
            isPrimary: g.isPrimary
        }));

        window.updateGuestTable?.();
        window.renderGuestList?.();

    })();


    // ========== RENDERING ==========
    function updateGuestTable() {
        const $tbody = $('#normalGuestTable tbody').empty();
        const normalGuests = guestList.filter(g => !g.isPrimary);
        $('#guestCount').text(normalGuests.length);

        if (normalGuests.length === 0) {
            $tbody.html(`<tr><td colspan="2" class="text-center text-muted">No guests added yet.</td></tr>`);
        } else {
            normalGuests.forEach(g => {
                $tbody.append(`
                        <tr data-guest-id="${g.id}">
                            <td>${(g.fullName)}</td>
                            <td>
                                <a class="text-teal-600 editGuestBtn" data-id="${g.id}" title="Edit"><i class="icon-pencil7"></i></a>
                                <a class="text-danger deleteGuestBtn ml-2" data-id="${g.id}" title="Delete"><i class="icon-trash"></i></a>
                                <a class="text-primary makePrimaryBtn ml-2" data-id="${g.id}" title="Make Primary"><i class="icon-user-check"></i></a>
                            </td>
                        </tr>
                    `);
            });
        }

        // Primary guest display
        const primary = guestList.find(g => g.isPrimary);
        if (primary) {
            $('#primaryGuestContainer').html(`
                    <div class="row">
                        <div class="col-md-2">
                            <img src="/assets/images/placeholder.jpg" class="img-circle img-md" alt="">
                        </div>
                        <div class="col-md-10">
                            <h5 class="text-primary">${(primary.fullName)}</h5>
                            <p>Email: ${(primary.email) || "-"}</p>
                            <p>Phone: ${(primary.phone) || "-"}</p>
                        </div>
                    </div>
                `);
            $('#editPrimaryBtn').show().data('id', primary.id);
        } else {
            $('#primaryGuestContainer').html(`<p class="text-muted">No primary guest selected.</p>`);
            $('#editPrimaryBtn').hide().removeData('id');
        }
    }

    function renderGuestList() {
        const container = $('#guestDisplayList');
        if (!container.length)
            return;
        //console.log("renderGuestList called, guestList:", guestList);

        container.empty();

        $('#guestCountLabel').text(`${guestList.length} guest${guestList.length !== 1 ? 's' : ''}`);
        $('#guestCount').text(guestList.filter(g => !g.isPrimary).length);

        guestList.forEach(g => {
            const badge = g.isPrimary ? `<span class="label label-primary">Primary</span>` : '';
            container.append(`
                    <li class="media" data-id="${g.id}">
                        <a class="media-left">
                            <img src="/assets/images/placeholder.jpg" class="img-circle img-md" alt="">
                        </a>
                        <div class="media-body">
                            <span class="media-heading text-default">${(g.fullName)} ${badge}</span>
                            <span class="text-size-small text-muted display-block">${(g.email)}</span>
                            <span class="text-size-small text-muted display-block">${(g.phone)}</span>
                        </div>
                    </li>
                `);
        });
    }


    // ========== SELECT2 SEARCH ==========
    $(function () {
        const $select = $('#guestSearchSelect');
        if ($select.length && $.fn.select2) {
            $select.select2({
                placeholder: "Search guest by name, email, or phone",
                minimumInputLength: 4,
                ajax: {
                    url: '/Guest/SearchGuests',
                    dataType: 'json',
                    delay: 250,
                    data: p => ({ term: p.term }),
                    processResults: data => ({
                        results: (data || []).map(g => ({ id: g.id, text: g.text }))
                    }),
                    cache: true
                },
                width: '100%'
            });
        }
    });

    $('#guestSearchSelect').on('select2:select', function (e) {
        var guestId = e.params.data.id;

        if (guestId) {
            $.ajax({
                url: '/Guest/GetGuestJson/' + guestId,
                type: 'GET',
                success: function (guest) {
                    //console.log("Guest Data", guest);

                    $('#guestId').val(guest.id);
                    $('#FullName').val(guest.fullName);
                    $('#Email').val(guest.email);
                    $('#Phone').val(guest.phone);
                    $('#Address').val(guest.address);
                    $('#proofTypeSelect').val(guest.proofTypeId).trigger('change'); // ✅ FIXED
                    $('#ProofNumber').val(guest.proofNumber);
                    $('#BranchId').val('@BranchId');

                    if (guest.dateOfBirth) {
                        $('#DateOfBirth').val(guest.dateOfBirth.split('T')[0]);
                    } else {
                        $('#DateOfBirth').val('');
                    }

                    $('#guestSearchSelect').val(null).trigger('change');
                },
                error: function () {
                    alert('❌ Failed to fetch guest data.');
                }
            });
        }
    });


    // ========== ADD / EDIT ==========
    $(document).on('submit', '#guestForm', function (e) {
        e.preventDefault();
        const data = {
            id: +$('#guestId').val() || 0,
            isPrimary: $('#isPrimary').is(':checked'),
            fullName: $('#FullName').val().trim(),
            email: $('#Email').val() || null,
            phone: $('#Phone').val() || null,
            proofTypeId: $('#proofTypeSelect').val() || null,
            proofNumber: $('#ProofNumber').val() || null,
            dateOfBirth: $('#DateOfBirth').val() || null,
            address: $('#Address').val() || null,
            branchId: $('#BranchId').val() || 0
        };

        $.ajax({
            url: '/Guest/AddOrEditGuest',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data)
        })
            .done(response => {
                if (!response?.success) return Swal.fire("Error", response?.message || "Failed to save guest.", "error");
                const guestId = response.guestId;

                // Clear previous primary if needed
                if (data.isPrimary) guestList.forEach(g => g.isPrimary = false);

                const existing = guestList.find(g => g.id === guestId);
                const updated = { ...data, id: guestId };

                if (existing) Object.assign(existing, updated);
                else guestList.push(updated);

                reservationGuestList = guestList.map(g => ({ guestId: g.id, isPrimary: g.isPrimary }));

                updateGuestTable();
                renderGuestList();
                resetGuestForm();
                toastr.success("Guest saved successfully.");
            })
            .fail(() => Swal.fire("Error", "Failed to save guest.", "error"));
    });


    // ========== EDIT (no AJAX) ==========
    $(document).on('click', '.editGuestBtn', function () {
        const guest = guestList.find(g => g.id == $(this).data('id'));
        if (!guest) return Swal.fire("Error", "Guest not found in list.", "error");
        populateGuestForm(guest);
    });

    $('#editPrimaryBtn').click(() => {
        const primary = guestList.find(g => g.isPrimary);
        if (!primary) return Swal.fire("Info", "No primary guest selected.", "info");
        populateGuestForm(primary);
    });

    function populateGuestForm(g) {
        $('#guestId').val(g.id);
        $('#isPrimary').prop('checked', g.isPrimary);
        $('#FullName').val(g.fullName);
        $('#Email').val(g.email);
        $('#Phone').val(g.phone);
        $('#proofTypeSelect').val(g.proofTypeId || '').trigger('change');
        $('#ProofNumber').val(g.proofNumber || '');
        $('#DateOfBirth').val(g.dateOfBirth ? g.dateOfBirth.split('T')[0] : '');
        $('#Address').val(g.address || '');
        $('#BranchId').val(g.branchId || '');
    }


    // ========== DELETE ==========
    $(document).on('click', '.deleteGuestBtn', function () {
        const guestId = $(this).data('id');
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-danger',
                cancelButton: 'btn btn-default custom-cancel-btn'
            },
            buttonsStyling: false
        });
        swalWithBootstrapButtons.fire({
            position: "top",
            title: "Are you sure?",
            text: "This will remove the guest from reservation!",
            icon: "warning",
            iconColor: "red",
            showCancelButton: true,
            confirmButtonText: "Delete!",
            cancelButtonText: "Cancel",
            reverseButtons: true
        }).then(res => {
            if (!res.isConfirmed) return;
            guestList = guestList.filter(g => g.id != guestId);
            reservationGuestList = reservationGuestList.filter(r => r.guestId != guestId);
            updateGuestTable();
            renderGuestList();
            toastr.success("Guest removed successfully.");
        });
    });


    // ========== MAKE PRIMARY ==========
    $(document).on('click', '.makePrimaryBtn', function () {
        const guestId = $(this).data('id');
        guestList.forEach(g => g.isPrimary = (g.id == guestId));
        reservationGuestList = guestList.map(g => ({ guestId: g.id, isPrimary: g.isPrimary }));
        updateGuestTable();
        renderGuestList();
        toastr.success("Primary guest updated.");
    });


    // ========== RESET ==========
    function resetGuestForm() {
        $('#guestForm')[0].reset();
        $('#guestId').val(0);
        $('#proofTypeSelect').val("").trigger("change");
        if ($('#guestForm').data('validator')) $('#guestForm').validate().resetForm();
        $('#guestSearchSelect').val(null).trigger('change');
    }
    $('#clearGuestForm').click(resetGuestForm);
</script>
