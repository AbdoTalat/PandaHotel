@model IEnumerable<GetAllFloorsDTO>

@{
    int rowNumber = 1;
    TempData["Title"] = "Floors";
}
<!-- Page header -->
<div class="page-header page-header-default">
    <div class="page-header-content">
        <div class="page-title">
            <h4><i class="icon-arrow-left52 position-left"></i> <span class="text-semibold">Floors</span>  </h4>
        </div>

        <div class="heading-elements">
            <div class="heading-btn-group">
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-bars-alt text-primary"></i><span>Statistics</span></a>
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-calculator text-primary"></i> <span>Invoices</span></a>
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-calendar5 text-primary"></i> <span>Schedule</span></a>
            </div>
        </div>
    </div>

    <div class="breadcrumb-line">
        <ul class="breadcrumb">
            <li><a asp-action="Index" asp-controller="Home"><i class="icon-home2 position-left"></i> Home</a></li>
            @* <li><a asp-action="Index" asp-controller="Floor">Settings</a></li> *@
            <li class="active">Floors  (@Model.Count())</li>
        </ul>

        <ul class="breadcrumb-elements">
            <li><a href="#"><i class="icon-comment-discussion position-left"></i> Support</a></li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    <i class="icon-gear position-left"></i>
                    Settings
                    <span class="caret"></span>
                </a>

                <ul class="dropdown-menu dropdown-menu-right">
                    <li><a href="#"><i class="icon-user-lock"></i> Account security</a></li>
                    <li><a href="#"><i class="icon-statistics"></i> Analytics</a></li>
                    <li><a href="#"><i class="icon-accessibility"></i> Accessibility</a></li>
                    <li class="divider"></li>
                    <li><a href="#"><i class="icon-gear"></i> All settings</a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<!-- /page header -->


<!-- Content area -->
<div class="content">

    <!-- Basic datatable -->
    <div class="panel panel-flat ">
        <div class="panel-heading">
            <h5 class="panel-title">Floors</h5>
            <div class="heading-elements" style=" margin-right:0px">
                @if (User.HasClaim("permission", "Floor.Add"))
                {
                    <button data-title="Add New Floor" data-url="/Floor/AddFloor" type="button" class="btn bg-teal-400 btn-lg btnOpenModal">
                        <i class="icon-plus-circle2" style="font-size:21px; margin-right:5px; margin-top:3px"></i>
                        Add Floor
                    </button>
                }
            </div>
        </div>

        <hr class="my-3" style="margin-top:5px">

        <div class="panel-heading" style="margin-bottom:40px">
            <div class="heading-elements">
                <ul class="icons-list">
                    <li><button id="toggleFilterBtn" class="btn bg-teal-400 "><i class="icon-filter3"></i> Filter</button> </li>
                    <li><a class="btn bg-teal-400" id="refreshFloorsBtn" style="color:#fff" data-action="reload"></a></li>
                    <li><a class="btn bg-teal-400" style="color:#fff" data-action="collapse"></a></li>
                </ul>
            </div>
        </div>

        <table class="table datatable-button-html5-basic dataTable">
            <thead>
                <tr class="border-double">
                    <th>#</th>
                    <th>Floor Number</th>
                    <th>Floor </th>
                    <th>Is Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr id="item-@item.Id">
                        <td>@rowNumber</td>
                        <td>@item.Number</td>
                        <td>@item.Number</td>
                        @if (item.IsActive)
                        {
                            <td><span class="label label-rounded label-success">Active</span></td>
                        }
                        else
                        {
                            <td><span class="label label-rounded label-danger">Not Active</span></td>
                        }
                        <td>
                            @if (User.HasClaim("permission", "Floor.Edit"))
                            {
                                <a data-title="Edit Floor" data-url="/Floor/EditFloor/@item.Id" class="text-teal-600 btnEditOpenModal"><i class="icon-pencil7" style="font-size:20px; margin-right:8px"></i> </a>
                            }
                            @if (User.HasClaim("permission", "Floor.Delete") && !item.IsActive)
                            {
                                <a data-id="@item.Id" class="text-danger-600 btn-delete"><i class="icon-trash" style="font-size:20px;margin-right:8px"></i> </a>
                            }
                        </td>
                    </tr>
                    rowNumber++;
                }
            </tbody>
        </table>
    </div>
</div>
<!-- /content area -->


@section Scripts{

    <script>
        $(document).ready(function () {
            $("#refreshFloorsBtn").click(function () {
                $.ajax({
                    url: '/Floor/GetAllFloorsJson',
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            var tbody = $("#floorsTable tbody");
                            tbody.empty(); // Clear existing data

                            // Get only the first 10 items
                            var floorsToShow = response.data.slice(0, 10);

                            $.each(floorsToShow, function (index, item) {
                                var statusLabel = item.isActive === "Active"
                                    ? '<span class="label label-rounded label-success">Active</span>'
                                    : '<span class="label label-rounded label-danger">Not Active</span>';

                                var actions = "";
                                if (item.canEditFloor) {
                                    actions += `<a data-title="Edit Floor" data-url="/Floor/EditFloor/${item.id}" class="text-teal-600 btnEditOpenModal">
                                                    <i class="icon-pencil7" style="font-size:20px; margin-right:8px"></i>
                                                </a>`;
                                }
                                if (item.canDeleteFloor) {
                                    actions += `<a data-id="${item.id}" class="text-danger-600 btn-delete">
                                                    <i class="icon-trash" style="font-size:20px;margin-right:8px"></i>
                                                </a>`;
                                }

                                var row = `<tr id="item-${item.id}">
                                            <td>${item.number}</td>
                                            <td>${item.floorNumber}</td>
                                            <td>${item.floorNumber}</td>
                                            <td>${item.createdAt}</td>
                                            <td>${statusLabel}</td>
                                            <td>${actions}</td>
                                        </tr>`;

                                tbody.append(row);
                            });
                        } else {
                            console.error("Failed to load floors.");
                        }
                    },
                    error: function () {
                        console.error("Error while fetching floors.");
                    }
                });
            });

            // Auto-load first 10 floors when the page loads
           // $("#refreshFloorsBtn").trigger("click");
        });

    </script>



    <script>
        $(document).ready(function () {
            const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                    confirmButton: 'btn btn-danger',
                    cancelButton: 'btn btn-default custom-cancel-btn'
                },
                buttonsStyling: false
            });

            $(".btn-delete").click(function () {
                let button = $(this);  // Reference to the clicked button
                let itemId = button.data("id");
                let row = button.closest("tr"); // Get the row that contains the button

                swalWithBootstrapButtons.fire({
                    position: "top",
                    title: "Are you sure?",
                    text: "You won't be able to revert this!",
                    icon: "warning",
                    iconColor: "red",
                    showCancelButton: true,
                    confirmButtonText: "Delete!",
                    cancelButtonText: "Cancel",
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/Floor/DeleteFloor/' + itemId,
                            type: 'DELETE',
                            success: function (response) {
                                if (response.success) {
                                    swalWithBootstrapButtons.fire({
                                        position: "top",
                                        title: "Deleted!",
                                        text: response.message,
                                        icon: "success",
                                        customClass: {
                                            confirmButton: 'btn btn-success'
                                        }
                                    }).then(() => {
                                        row.fadeOut(400, function () {
                                            $(this).remove();
                                        });
                                    });
                                } else {
                                    swalWithBootstrapButtons.fire({
                                        position: "top",
                                        title: "Error!",
                                        text: response.message,
                                        icon: "error"
                                    });
                                }
                            },
                            error: function () {
                                swalWithBootstrapButtons.fire({
                                    position: "top",
                                    title: "Error!",
                                    text: "Something went wrong!",
                                    icon: "error"
                                });
                            }
                        });
                    }
                });
            });
        });
    </script>


}